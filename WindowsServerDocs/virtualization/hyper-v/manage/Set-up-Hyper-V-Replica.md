---
title: 设置 Hyper-V 副本
description: 提供有关设置副本、测试故障转移和执行第一次复制的说明。
ms.topic: article
ms.assetid: eea9e996-bfec-4065-b70b-d8f66e7134ac
ms.author: benarm
author: BenjaminArmstrong
ms.date: 10/10/2016
ms.openlocfilehash: cfa21867503c091da42866aba4c9bc51050200ae
ms.sourcegitcommit: dd1fbb5d7e71ba8cd1b5bfaf38e3123bca115572
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 09/17/2020
ms.locfileid: "90746642"
---
# <a name="set-up-hyper-v-replica"></a>设置 Hyper-V 副本

>适用于：Windows Server 2016

Hyper-V 副本是 Hyper-V 角色不可或缺的组成部分。 它通过将虚拟机从一台 Hyper-v 主机服务器复制到另一台 Hyper-v 主机服务器来提供灾难恢复策略，使工作负荷保持可用。  Hyper-v 副本创建活动虚拟机到副本脱机虚拟机的副本。 注意以下事项：

-   **Hyper-v 主机**：主要和辅助主机服务器可以在物理上归置，也可以位于单独的地理位置，并通过 WAN 链接进行复制。 Hyper-v 主机可以是独立的，也可以是群集的，也可以是二者的组合。 服务器之间没有 Active Directory 依赖关系，它们不需要是域成员。

-   **复制和更改跟踪**：为特定虚拟机启用 Hyper-v 副本后，初始复制会在辅助主机服务器上创建相同的副本虚拟机。 在这种情况下，Hyper-v 副本更改跟踪创建并维护一个日志文件，该文件捕获虚拟机 VHD 上的更改。 日志文件根据复制频率设置按照反向顺序播放到副本 VHD。 这意味着会以异步方式存储和复制最新更改。 可以通过 HTTP 或 HTTPS 进行复制。

-   **扩展 (链接) 复制**：这允许你将虚拟机从主主机复制到辅助主机，然后将辅助主机复制到第三台主机。 请注意，无法从主主机直接复制到第二个和第三个。

    此功能使 Hyper-v 副本更可靠地进行灾难恢复，因为如果发生中断，你可以从主副本和扩展副本进行恢复。  如果主位置和辅助位置发生故障，可以故障转移到扩展副本。 请注意，扩展副本不支持应用程序一致的复制，并且必须使用辅助副本使用的同一 Vhd。

-   **故障转移**：如果主 (或辅助数据库发生故障，以防扩展) 位置，则可以手动启动测试、计划或非计划的故障转移。

    | 问题 | 测试 | 已计划 | 计划外 |
    |--|--|--|--|
    | 应该在何时运行？ | 验证虚拟机是否可以在辅助站点中故障转移并启动<p>适用于测试和培训 | 在计划停机和中断期间 | 出现意外事件时 |
    | 是否创建了重复的虚拟机？ | 是 | 否 | 否 |
    | 它在何处启动？ | 在副本虚拟机上 | 在主计算机上启动，在辅助计算机上完成 | 在副本虚拟机上 |
    | 运行的频率如何？ | 建议每月一次进行测试 | 每六个月或符合法规要求 | 仅在主虚拟机不可用的情况下发生灾难时 |
    | 主虚拟机是否继续复制？ | 是 | 是。 当中断解决时，反向复制会将更改复制回主站点，以便同步主站点和辅助站点。 | 否 |
    | 是否有任何数据丢失？ | 无 | 无。 故障转移后，Hyper-v 副本将最后一组跟踪的更改复制回主副本，以确保零数据丢失。 | 取决于事件和恢复点 |
    | 有无任何故障时间？ | 无。 它不会影响你的生产环境。 在故障转移期间，它会创建重复的测试虚拟机。 故障转移完成后，在副本虚拟机上选择 " **故障转移** "，它会自动清理并删除。 | 计划中断的持续时间 | 计划外中断的持续时间 |

-   **恢复点**：配置虚拟机的复制设置时，需要指定要从中存储的恢复点。 恢复点代表可恢复虚拟机的时间的快照。 如果从最新的恢复点进行恢复，显然会丢失更少的数据。 你可以访问最多24小时前的恢复点。

## <a name="deployment-prerequisites"></a>部署先决条件
在开始之前，应该先验证以下内容：

-   **确定哪些 vhd 需要复制**。 特别是，不应从复制中排除包含副本服务器快速更改且未使用的数据的 Vhd （如页面文件磁盘），以节省网络带宽。 记下可以排除哪些 Vhd。

-   **确定你需要同步数据的频率**：副本服务器上的数据将根据你配置的复制频率（ (30 秒、5分钟或15分钟) 进行同步更新。 选择的频率应考虑以下各项：虚拟机是否运行具有较低 RPO 的关键数据？ 什么是带宽注意事项？  你的高度关键虚拟机显然需要更频繁地复制。

-   **决定如何恢复数据**：默认情况下，hyper-v 副本仅存储一个恢复点，该恢复点将是从主副本发送到辅助副本的最新复制。 但是，如果你希望将数据恢复到以前的某个时间点，则可以指定应将额外的恢复点存储 (最多) 24 小时点。 如果确实需要其他恢复点，请注意，这需要更多的处理和存储资源开销。

-   确定**要复制的工作负荷**：标准 hyper-v 副本复制在故障转移后保持虚拟机操作系统状态的一致性，而不是在虚拟机上运行的应用程序的状态。 如果希望能够恢复工作负荷状态，可以创建应用一致的恢复点。 请注意，如果使用扩展 (链接) 复制，则无法在扩展副本站点上使用应用一致的恢复。

-   **确定如何执行虚拟机数据的初始复制**：通过传输需要传输虚拟机的当前状态来启动复制。 这种初始状态可以通过现有网络直接传输，立即或你进行配置的稍晚时间均可。 你还可以使用预先存在的已还原虚拟机 (例如，如果你已还原副本服务器上的虚拟机的早期备份) 作为初始副本。 或者，你可以将初始副本复制到外部媒体，然后以物理方式向副本站点传递媒体，这样能够节省网络带宽。  如果要使用预先存在的虚拟机，请删除所有与之关联的以前的快照。

## <a name="deployment-steps"></a>部署步骤

### <a name="step-1-set-up-the-hyper-v-hosts"></a>步骤1：设置 Hyper-v 主机
每台服务器上至少需要两台具有一个或多个虚拟机的 Hyper-v 主机。 [Hyper-v 入门](../get-started/Get-started-with-Hyper-V-on-Windows.md)。 要将虚拟机复制到的主机服务器需要设置为副本服务器。

1.  在 "要将虚拟机复制到的服务器的 Hyper-v 设置" 的 " **复制配置**" 中，选择 " **启用此计算机作为副本服务器**"。

2.  可以通过 HTTP 或加密的 HTTPS 进行复制。 选择 " **使用 Kerberos (HTTP) ** 或 **使用基于证书的身份验证 (HTTPS**) 。 默认情况下，在副本 Hyper-v 服务器上将 HTTP 80 和 HTTPS 443 作为防火墙例外启用。 如果更改默认端口设置，则还需要更改防火墙例外。 如果要通过 HTTPS 进行复制，则需要选择证书，并应设置证书身份验证。

3.  对于 "授权"，请选择 " **允许来自任何经过身份验证的服务器的复制** "，以允许副本服务器接受来自任何成功进行身份验证的主服务器的虚拟机复制流量。 选择 **"允许从指定服务器复制** "，以仅接受来自你具体选择的主服务器的流量。

    对于这两个选项，你可以指定复制的 Vhd 应存储在副本 Hyper-v 服务器上的位置。

4.  单击“**确定**”或“**应用**”。

### <a name="step-2-set-up-the-firewall"></a>步骤2：设置防火墙
若要允许在主服务器和辅助服务器之间进行复制，流量必须通过 Windows 防火墙 (或任何其他第三方防火墙) 。 默认情况下，当你在服务器上安装 Hyper-v 角色时，会创建 HTTP (80) 和 HTTPS (443) 。 如果使用这些标准端口，只需启用这些规则：

-  在独立主机服务器上启用规则：

    1. 打开“高级安全 Windows 防火墙”，然后单击 **“入站规则”**。

    2. 若要启用 HTTP (Kerberos) 身份验证，请右键单击 " **hyper-v 副本 HTTP 侦听器" ("TCP") **  > **启用规则 "。** 若要启用基于 HTTPS 证书的身份验证，请右键单击 " **Hyper-v 副本 HTTPS 侦听器" ("TCP) ** > E**启用规则**。

-  若要在 Hyper-v 群集上启用规则，请使用 "以 **管理员身份运行**" 打开 Windows PowerShell 会话，并运行以下命令之一：

    -   对于 HTTP：  `get-clusternode | ForEach-Object  {Invoke-command -computername $_.name -scriptblock {Enable-Netfirewallrule -displayname "Hyper-V Replica HTTP Listener (TCP-In)"}}`

    -   对于 HTTPS： `get-clusternode | ForEach-Object  {Invoke-command -computername $_.name -scriptblock {Enable-Netfirewallrule -displayname "Hyper-V Replica HTTPS Listener (TCP-In)"}}`

### <a name="enable-virtual-machine-replication"></a>启用虚拟机复制
在要复制的每个虚拟机上执行以下操作：

1.  在 Hyper-v 管理器的 **详细信息** 窗格中，通过单击来选择虚拟机。
    右键单击选定的虚拟机，然后单击 " **启用复制** " 以打开 "启用复制向导"。

2.  在“开始之前”**** 页上单击“下一步”****。

3.  在 " **指定副本** 服务器" 页上的 "副本服务器" 框中，输入副本服务器的 NETBIOS 或 FQDN。 如果副本服务器是故障转移群集的一部分，请输入 Hyper-v 副本代理的名称。 单击“下一步”。

4.  在 " **指定连接参数** " 页上，hyper-v 副本将自动检索为副本服务器配置的身份验证和端口设置。 如果未检索到值，请检查服务器是否已配置为副本服务器，以及是否已在 DNS 中注册。 如果在设置中手动输入，则为。

5.  在 " **选择复制 vhd** " 页上，确保选中要复制的 vhd，并清除要从复制中排除的任何 vhd 的复选框。 然后单击“下一步”  。

6.  在 " **配置复制频率** " 页上，指定更改从主数据库同步到辅助副本的频率。 然后单击“下一步”  。

7.  在 " **配置其他恢复点** " 页上，选择是要仅维护最新的恢复点还是创建其他点。    如果希望始终恢复具有自己的 VSS 编写器的应用程序和工作负荷，建议选择 **卷影复制服务 (VSS) frequenc**y，并指定创建应用一致性快照的频率。 请注意，Hyper-v VMM 请求程序服务必须同时在主和辅助 Hyper-v 服务器上运行。 然后单击“下一步”  。

8.  在 " **选择初始复制** " 页上，选择要使用的初始复制方法。  通过网络发送初始副本的默认设置会将主虚拟机配置文件 (.VMCX) 和 (VHDX 和 VHD 的虚拟硬盘文件复制到通过网络连接选择的) 。 如果要使用此选项，请验证网络带宽可用性。 如果主虚拟机已在辅助站点上配置为复制虚拟机，则选择  **"使用复制服务器上现有的虚拟机作为初始副本**" 会很有用。 你可以使用 Hyper-v 导出来导出主虚拟机，并将其导入为辅助服务器上的副本虚拟机。 对于更大的虚拟机或有限带宽，你可以选择在以后通过网络进行初始复制，然后配置非高峰时段，或将初始复制信息作为脱机媒体发送。

    如果执行脱机复制，将使用外部存储介质（如硬盘或 USB 驱动器）将初始副本传输到辅助服务器。 要执行此操作，需要将外部存储连接到群集中的主服务器 (或所有者节点) 然后选择 "使用外部媒体发送初始副本" 时，可以在本地或在可存储初始副本的外部介质上指定位置。  在副本站点上创建了一个占位符虚拟机。 初始复制完成后，可以将外部存储发送到副本站点。 在这里，你将把外部媒体连接到辅助服务器或辅助群集的所有者节点。 然后，将初始副本导入到指定位置，并将其合并到占位符虚拟机中。

9. 在 "**完成启用复制**" 页上，查看 "摘要" 中的信息，然后单击 "**完成"。** 将根据你选择的设置传输虚拟机数据。 此时将显示一个对话框，指示已成功启用复制。

10. 如果要配置扩展 (链接) 复制，请打开副本服务器，然后右键单击要复制的虚拟机。 单击 "**复制**" "  >  **扩展复制**"，并指定复制设置。

## <a name="run-a-failover"></a>运行故障转移
完成这些部署步骤后，复制的环境就会启动并运行。 现在，可以根据需要运行故障转移。

**测试故障转移**：如果想要运行测试故障转移，请右键单击主虚拟机，然后选择 "**复制**  >  **测试故障转移**"。 选择最新或其他恢复点（如果已配置）。 新的测试虚拟机将在辅助站点上创建和启动。 完成测试后，选择要清理的副本虚拟机上的 "  **停止测试故障转移** "。 请注意，对于虚拟机，一次只能运行一个测试故障转移。 [了解详细信息](https://blogs.technet.com/b/virtualization/archive/2012/07/26/types-of-failover-operations-in-hyper-v-replica.aspx)。

**计划的故障转移**：若要运行计划的故障转移，请右键单击主虚拟机，然后选择 "**复制**  >  **计划的故障转移**"。 计划的故障转移执行先决条件检查，以确保零数据丢失。 在开始故障转移之前，它会检查主虚拟机是否已关闭。 虚拟机进行故障转移后，它将在主站点可用时开始将更改复制回主站点。 请注意，为实现此操作，应将主服务器配置为从辅助服务器或从 Hyper-v 副本代理（对于主群集）接收复制。 计划的故障转移将发送最后一组跟踪的更改。 [了解详细信息](https://blogs.technet.com/b/virtualization/archive/2012/07/31/types-of-failover-operations-in-hyper-v-replica-part-ii-planned-failover.aspx)。

非**计划的故障**转移：若要运行非计划的故障转移，请右键单击副本虚拟机，然后从 hyper-v 管理器或故障转移群集管理器中选择 "**复制**未  >  **计划的故障转移**"。 如果启用此选项，则可以从最新的恢复点或从以前的恢复点恢复。 故障转移后，请检查已故障转移的虚拟机上的所有内容是否按预期运行，然后单击副本虚拟机上的 " **完成** "。 [了解详细信息](https://blogs.technet.com/b/virtualization/archive/2012/08/08/types-of-failover-operations-in-hyper-v-replica-part-iii-unplanned-failover.aspx)。
