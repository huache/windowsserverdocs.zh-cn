---
ms.assetid: 6f50476c-a1f1-48fb-999b-76c4c3816496
title: 规划泄露
author: iainfoulds
ms.author: iainfou
manager: daveba
ms.date: 05/31/2017
ms.topic: article
ms.openlocfilehash: 9be3768f4ac0f95c1c268d9a4efb55af3f74d304
ms.sourcegitcommit: 1dc35d221eff7f079d9209d92f14fb630f955bca
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/26/2020
ms.locfileid: "88941397"
---
# <a name="planning-for-compromise"></a>规划泄露

>适用于：Windows Server 2016、Windows Server 2012 R2、Windows Server 2012

*定律一：无人相信可能发生的任何错误，直到发生这种情况。* - [安全管理的10个永恒定律](/previous-versions/cc722488(v=technet.10))

在许多组织中，灾难恢复计划侧重于从导致计算服务丢失的区域灾难或故障中恢复。 但是，在使用受到攻击的客户时，我们经常会发现，在灾难恢复计划中，从有意的折衷中恢复是不存在的。 这在以下情况下尤其适用：泄漏导致知识产权或故意销毁利用逻辑边界 (如销毁所有 Active Directory 域或所有服务器) 而不是物理 (边界，如销毁数据中心) 。 尽管组织可能具有定义初始活动的事件响应计划，但在发现安全漏洞时，这些计划通常会忽略影响整个计算基础结构的折衷的步骤。

由于 Active Directory 为用户、服务器、工作站和应用程序提供丰富的标识和访问管理功能，攻击者始终以攻击者为目标。 如果攻击者获得对 Active Directory 域或域控制器的高特权访问权限，则可以利用该访问权限访问、控制甚至销毁整个 Active Directory 林。

本文档讨论了对 Windows 的一些最常见攻击，以及你可以实现以减少攻击面的 Active Directory 和对策，但在 Active Directory 的完全泄漏的情况下，唯一的恢复方法是在发生这种情况之前为折衷做好准备。 本部分的内容更少于本文档前面部分的技术实现细节，还提供了更多详细信息，可用于创建全面、全面的方法来保护和管理组织的关键业务和 IT 资产。

无论你的基础结构是否从未遭受攻击，田园尝试了违规行为，或者是否已 succumbed 攻击，以及是否已完全泄露，你都应该计划将再次遭到攻击。 不可能阻止攻击，但实际上可能会妨碍严重的破坏或大规模的泄露。 每个组织都应仔细评估其现有的风险管理计划，并做出必要的调整，以通过在预防、检测、包含和恢复方面做出平衡投资来帮助降低其总体安全级别。

若要创建有效的防御，同时向依赖于你的基础结构和应用程序的用户和企业提供服务，你可能需要考虑 novel 方法，以防止、检测和在你的环境中受到损害，然后再从泄露中恢复。 本文档中的方法和建议可能无法帮助你修复已泄露的 Active Directory 安装，但可以帮助你保护下一项。

Windows Server 2012 中提供了有关恢复 Active Directory 林的建议 [：规划 Active Directory 林恢复](https://www.microsoft.com/download/details.aspx?id=16506)。 您可能能够防止您的新环境受到完全损害，但即使您不能，您也可以使用这些工具来恢复和重新获得对您的环境的控制。

## <a name="rethinking-the-approach"></a>反思方法
*定律数八：防御网络的难点与复杂性是直接成比例的。* - [安全管理的10个永恒定律](/previous-versions/cc722488(v=technet.10))

通常情况下，如果攻击者已获得对计算机的系统、管理员、根或等效访问权限（无论操作系统如何），就不能再将该计算机视为可信计算机，无论对系统进行了多少努力。 Active Directory 没有任何区别。 如果攻击者已获取 Active Directory 中的域控制器或高特权帐户的特权访问权限，除非您记录了攻击者所做的每项修改或已知的良好备份，否则您永远都不能将该目录还原到完全信任的状态。

当成员服务器或工作站被攻击者泄露并更改时，该计算机将不再可信，但仍可信任邻近的无服务器和工作站。 一台计算机的危害并不意味着所有计算机都受到威胁。

但是，在 Active Directory 域中，所有域控制器都承载相同 AD DS 数据库的副本。 如果单一域控制器被泄露，并且攻击者修改了 AD DS 数据库，则这些修改将复制到域中的每个其他域控制器，并且根据进行修改的分区（林）而定。 即使在林中重新安装了每个域控制器，也只需重新安装 AD DS 数据库所在的主机。 对 Active Directory 所做的恶意修改会将其复制到最近安装的域控制器，并将其复制到已运行多年的域控制器。

在评估已泄露的环境时，我们通常会发现，被认为是第一次被破坏的 "事件" 实际上是在几周、几个月甚至几年后，攻击者最初被破坏了环境。 攻击者通常会在检测到违规之前获得高特权帐户的凭据，并利用这些帐户来破坏目录、域控制器、成员服务器、工作站甚至连接的非 Windows 系统。

这些发现与 Verizon 的2012数据违规调查报告中的几个发现一致，其中指出：

-   98从外部代理词干的数据泄露百分比

-   85% 的数据泄露花了几周或更多时间来发现

-   92% 的事件已被第三方发现，

-   尽管简单或中间控件能够避免了97% 的违规。

对前面所述的程度的破坏实际上是无法修复的，而且在 Active Directory 受到损害或破坏的情况下，对每个受损系统进行 "平展和重建" 的标准建议并不可行，甚至可能是不可能的。 即使还原到已知的良好状态，也不会消除允许在第一次泄漏环境时出现的漏洞。

尽管你必须为基础结构的每个层面提供保护，但攻击者只需在防护中查找足够的缺陷即可达到其预期目标。 如果你的环境相对简单、处于纯洁并且经过良好管理，则实施本文档前面提供的建议可能是一个非常简单的陈述。

但是，我们发现环境越旧、更大、更复杂，就越有可能，本文档中的建议并不可行，甚至无法实现。 事实证明，确保基础结构的安全比从头开始更难，并构建可抵御攻击和危害的环境。 但正如前文所述，重建整个 Active Directory 林并没有一小任务。 出于此原因，我们建议使用更加集中的目标方法来保护 Active Directory 林。

请不要关注和尝试修复 "已损坏" 的所有内容，而是考虑一种方法，根据在业务和基础结构中最重要的内容来确定优先级。 不要尝试修正使用过时的、配置错误的系统和应用程序填充的环境，而应考虑创建一个新的小型安全环境，你可以在其中安全地移植用户、系统和对你的业务最重要的信息。

在本部分中，我们将介绍一种方法，通过该方法，你可以创建一个可用作核心业务基础结构的 "生命船" 或 "安全单元" 的处于纯洁 AD DS 林。 处于纯洁林只是新安装的 Active Directory 林中，通常是大小和范围有限的，它是使用当前操作系统、应用程序以及 [降低 Active Directory 攻击面](../../../ad-ds/plan/security-best-practices/../../../ad-ds/plan/security-best-practices/Reducing-the-Active-Directory-Attack-Surface.md)中所述的原则构建的。

通过在新构建的林中实施推荐的配置设置，你可以创建一个 AD DS 安装，该安装是从一开始就使用安全的设置和做法构建的，你可以减少支持旧系统和应用程序的问题。 虽然设计和实现处于纯洁 AD DS 安装的详细说明不在本文档的讨论范围内，但你应遵循一些常规原则和指导原则，以创建一个可在其中存放最关键资产的 "安全单元"。 这些准则如下所示：

1.  确定用于隔离和保护关键资产的原则。

2.  定义受限的基于风险的迁移计划。

3.  必要时，请利用 "nonmigratory" 迁移。

4.  实现 "创造性销毁"。

5.  隔离旧系统和应用程序。

6.  简化最终用户的安全性。

### <a name="identifying-principles-for-segregating-and-securing-critical-assets"></a>确定用于隔离和保护关键资产的原则

你创建的处于纯洁环境的特性可能会有很大的差异。 例如，你可以选择创建一个处于纯洁林，以便仅将 VIP 用户和敏感数据迁移到只有这些用户可以访问的数据。 你可以创建处于纯洁林，其中你不仅可以迁移 VIP 用户，还可以将其作为管理林来实现，实现 [降低 Active Directory 攻击面](../../../ad-ds/plan/security-best-practices/../../../ad-ds/plan/security-best-practices/Reducing-the-Active-Directory-Attack-Surface.md) 中所述的原则，以创建可用于从处于纯洁林中管理旧版林的安全管理帐户和主机。 你可以实现一个 "专门构建的" 林，其中驻留了 VIP 帐户、特权帐户和需要额外安全性的系统，如运行 Active Directory 证书服务的服务器 (AD CS) ，其唯一目的是将这些服务器与不太安全的林分离。 最后，您可以实现一个处于纯洁林，使其成为所有新用户、系统、应用程序和数据的事实上的位置，从而使您能够通过 attrition 最终解除旧林的授权。

无论你的处于纯洁林中是否包含少量的用户和系统，或是为了进行更严格的迁移而形成基础，你都应在规划中遵循以下原则：

1.  假设旧版林已泄露。

2.  不要将处于纯洁环境配置为信任旧版林，但你可以将旧环境配置为信任处于纯洁林。

3.  如果可能已恶意修改了帐户的组成员身份、SID 历史记录或其他属性，请不要将用户帐户或组从旧林迁移到处于纯洁环境。 请改用 "nonmigratory" 方法填充处于纯洁林。 本部分稍后将介绍 (Nonmigratory 方法。 ) 

4.  不要将计算机从旧版林迁移到处于纯洁林。 在处于纯洁林中实施全新安装的服务器，在刚刚安装的服务器上安装应用程序，并将应用程序数据迁移到新安装的系统。 对于文件服务器，将数据复制到刚安装的服务器，使用新林中的用户和组设置 Acl，然后使用类似的方式创建打印服务器。

5.  不允许在处于纯洁林中安装旧版操作系统或应用程序。 如果应用程序不能更新和全新安装，请将其留在旧林中，并考虑创造性销毁来替换应用程序的功能。

### <a name="defining-a-limited-risk-based-migration-plan"></a>定义受限的基于风险的迁移计划
创建一个有限的、基于风险的迁移计划，这只意味着在决定要迁移到处于纯洁林中的用户、应用程序和数据时，应根据你的组织在某个用户或系统泄露的风险程度确定迁移目标。 用户的帐户最有可能被攻击者的目标的 VIP 用户应该位于处于纯洁林中。 提供重要业务功能的应用程序应安装在处于纯洁林中经过全新构建的服务器上，并将高度敏感的数据移到处于纯洁林中的安全服务器。

如果你还没有清楚地了解 Active Directory 环境中最重要的业务用户、系统、应用程序和数据，请与业务部门合作来识别它们。 应识别业务运行所需的任何应用程序，这与运行关键应用程序或关键数据的任何服务器有关。 通过确定你的组织继续正常工作所需的用户和资源，你可以创建一个自然优先级的资产集合来集中精力。

### <a name="leveraging-nonmigratory-migrations"></a>利用 "Nonmigratory" 迁移
无论你是否知道环境已遭到破坏、怀疑它已泄露，或者只是不想将旧的数据和对象从旧的 Active Directory 安装迁移到新的，请考虑在技术上不 "迁移" 对象的迁移方法。

### <a name="user-accounts"></a>用户帐户
在传统的 Active Directory 从一个林迁移到另一个林时，用户对象上的 SIDHistory (SID 历史记录) 特性用于存储用户的 SID 和用户作为旧林中成员的组的 sid。 如果用户帐户已迁移到新的林，并且他们访问旧林中的资源，则 SID 历史记录中的 Sid 用于创建访问令牌，该令牌允许用户在迁移帐户之前访问其具有访问权限的资源。

然而，维护 SID 历史记录在某些环境中已经过验证，因为使用当前和历史 Sid 填充用户的访问令牌可能会导致令牌膨胀。 令牌膨胀的问题是，必须存储在用户的访问令牌中的 Sid 数使用或超过令牌中的可用空间量。

尽管令牌大小可以提高到有限的范围，但令牌膨胀的终极解决方案是减少与用户帐户关联的 Sid 数，无论是通过合理化组成员身份、删除 SID 历史记录还是同时使用二者。 有关令牌膨胀的详细信息，请参阅 [MaxTokenSize 和 Kerberos 令牌膨胀](/archive/blogs/shanecothran/maxtokensize-and-kerberos-token-bloat)。

不是从旧环境迁移用户 (尤其是可以使用 SID 历史记录泄露组成员身份和 SID 历史记录) ，请考虑利用元目录应用程序 "迁移" 用户，而无需将 SID 历史记录到新的林中。 在新林中创建用户帐户时，可以使用元目录应用程序将帐户映射到旧林中的相应帐户。

若要为新用户帐户提供对旧林中资源的访问权限，可以使用元目录工具来标识向其授予了用户的旧帐户访问权限的资源组，然后将用户的新帐户添加到这些组。 根据旧林中的组策略，可能需要创建域本地组以进行资源访问，或将现有组转换为域本地组，以允许将新帐户添加到资源组。 首先重点介绍最关键的应用程序和数据，并将这些应用程序和数据迁移到新的环境中 (有或没有 SID 历史记录) ，你可以限制旧环境中所需的工作量。



### <a name="servers-and-workstations"></a>服务器和工作站
与迁移用户、组和应用程序相比，在传统的从一 Active Directory 林迁移到另一林的迁移中，计算机的迁移相对比较简单。 如果迁移到新的林，则迁移到新林的方式与脱离旧域和加入新域的方式非常简单，具体取决于计算机角色。 但是，将计算机帐户原封不动地迁移到处于纯洁林中会造成创建全新环境的目的。 你应该在新的环境中全新安装服务器和工作站，而不是将 (可能被泄露、配置不当或过时的) 计算机帐户迁移到新的林。 你可以将数据从旧林中的系统迁移到处于纯洁林中的系统，而不是承载数据的系统。

### <a name="applications"></a>应用程序

应用程序在从一个林迁移到另一个林的任何迁移中都可能会带来最大的挑战，但在 "nonmigratory" 迁移的情况下，你应该应用的最基本原则之一是，处于纯洁林中的应用程序应该是最新的、支持的和全新安装的。 可以从旧林中的应用程序实例迁移数据（如果可能）。 在处于纯洁林中无法 "重新创建" 应用程序的情况下，应考虑诸如以下部分中所述的一些方法，如创造性销毁或隔离旧版应用程序。

### <a name="implementing-creative-destruction"></a>实现创造性销毁
创造性销毁是一项经济术语，用于描述由之前的订单销毁所创建的经济开发。 在最近几年中，术语已应用于信息技术。 它通常是指通过这种方法消除旧的基础结构，而不是通过升级，而是将其替换为全新的内容。 2011 [Gartner 研讨会 ITXPO](http://www.gartner.com/technology/symposium/orlando/) 为 cio 和高级 IT 经理提供了创造性的销毁，作为成本降低和提高效率的关键主题。 安全改进可以作为过程的自然 outgrowth。

例如，组织可能由多个业务单位组成，它们使用不同的应用程序来执行类似的功能，同时 modernity 和供应商支持。 从历史角度来看，它可能负责单独维护每个业务单位的应用程序，而合并工作由尝试确定哪些应用程序提供了最佳功能，然后将数据从其他应用程序迁移到该应用程序。

在创造性销毁中，不是保留过时或冗余的应用程序，而是实现全新的应用程序来替换旧的应用程序，将数据迁移到新的应用程序，并解除旧应用程序和运行它们的系统的授权。 在某些情况下，你可以通过在你自己的基础结构中部署新的应用程序来实现旧版应用程序的创造性销毁，但在任何可能的情况下，应考虑将应用程序移植到基于云的解决方案。

通过部署基于云的应用程序来替换旧的内部应用程序，你不仅可以降低维护工作量和成本，还可以通过消除为攻击者提供的漏洞来利用的遗留系统和应用程序，降低组织的攻击面。 此方法为组织提供了一种更快的方法来获取所需的功能，同时还消除了基础结构中的旧目标。 尽管创造性销毁原则不适用于所有 IT 资产，但它提供了一个用于消除旧系统和应用程序的常用选项，同时还能同时部署强大的、安全的基于云的应用程序。

### <a name="isolating-legacy-systems-and-applications"></a>隔离旧系统和应用程序
将业务关键的用户和系统迁移到处于纯洁、安全环境的自然 outgrowth 是，你的旧林将包含不太重要的信息和系统。 尽管遗留在不安全的环境中的旧系统和应用程序可能会带来安全隐患，但它们也表示降低的严重性。 通过 rehoming 和现代化你的关键业务资产，你可以专注于部署有效的管理和监视，而无需容纳旧的设置和协议。

将关键数据重新连接到处于纯洁林后，可以评估选项，进一步隔离 "main" AD DS 林中的旧系统和应用程序。 尽管你可能会实施创造性销毁来替换一个应用程序和运行该应用程序的服务器，但在其他情况下，你可能会考虑额外隔离最不安全的系统和应用程序。 例如，少量用户使用的应用程序，但需要旧版凭据（如 LAN Manager 哈希），可以将其迁移到创建的小型域，以支持没有替换选项的系统。

通过将这些系统从强制实施旧设置的域中删除，你可以通过将它们配置为仅支持当前的操作系统和应用程序，从而提高域的安全性。 不过，最好尽可能地取消旧系统和应用程序的授权。 如果解除授权只是一小部分旧人口，则将其隔离到单独的域 (或林) 使你可以在旧安装的其余部分执行增量改进。

### <a name="simplifying-security-for-end-users"></a>简化最终用户的安全性
在大多数组织中，有权访问最敏感信息的用户，因为他们在组织中的角色性质，常常会花费最少的时间来学习复杂的访问限制和控制。 尽管你应为组织中的所有用户提供全面的安全教育计划，但你还应着重于使安全性尽可能简单，因为它实现了透明的控件并简化了用户所遵循的原则。

例如，你可以定义一个策略，要求执行官和其他 Vip 使用安全工作站来访问敏感数据和系统，从而使他们能够使用其他设备来访问不太敏感的数据。 这是用户要记住的一个简单原则，但你可以实现一些后端控制，以帮助强制实施此方法。

如果用户使用智能卡登录到安全系统，则可以使用 [身份验证机制保证](/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/dd391847(v=ws.10)) 来允许用户访问敏感数据，并且可以使用 IPsec 和用户权限限制来控制可从中连接到敏感数据存储库的系统。 您可以使用 [Microsoft 数据分类工具包](https://www.microsoft.com/download/details.aspx?id=27123) 构建强大的文件分类基础结构，还可以实现 [动态访问控制](/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/dd391847(v=ws.10)) ，以根据访问尝试的特征限制对数据的访问，将业务规则转换为技术控制。

从用户的角度来看，从安全系统访问敏感数据 "简单"，然后尝试从不安全系统中执行此操作 "不是"。 但是，从监视和管理你的环境的角度来看，你将帮助你在用户访问敏感数据和系统的方式中创建可识别模式，使你能够更轻松地检测异常的访问尝试。

在用户抵抗长的环境中，复杂密码导致密码策略不足（特别是对于 VIP 用户），请考虑使用替代方法进行身份验证，无论是通过智能卡进行身份验证，还是使用额外的功能来增强身份验证) 、生物识别控制（如 finger 式读卡器），甚至是由受信任的平台模块保护的身份验证数据（用户 (计算机中的 TPM) 芯片） (。 尽管多重身份验证不会阻止凭据被盗攻击，但如果计算机已经泄露，为用户提供易于使用的身份验证控制，您可以为其传统的用户名和密码控件所使用的用户帐户分配更可靠的密码。
