---
ms.assetid: 4cc9c16c-1928-4dce-a3a8-6229be28eb65
title: Active Directory 复制概念
author: iainfoulds
ms.author: iainfou
manager: daveba
ms.date: 05/31/2017
ms.topic: article
ms.openlocfilehash: 403a8be3d6b7fc6330395bf6e4d20141e01b76ba
ms.sourcegitcommit: 1dc35d221eff7f079d9209d92f14fb630f955bca
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/26/2020
ms.locfileid: "88940317"
---
# <a name="active-directory-replication-concepts"></a>Active Directory 复制概念

>适用于：Windows Server 2016、Windows Server 2012 R2、Windows Server 2012

在设计站点拓扑之前，请熟悉某些 Active Directory 复制概念。

-   [Connection 对象](#BKMK_1)

-   [KCC](#BKMK_2)

-   [故障转移功能](#BKMK_3)

-   [子网](#BKMK_4)

-   [站点](#BKMK_5)

-   [站点链接](#BKMK_6)

-   [站点链接桥](#BKMK_7)

-   [站点链接传递性](#BKMK_8)

-   [全局编录服务器](#BKMK_9)

-   [通用组成员身份缓存](#BKMK_10)

## <a name="connection-object"></a><a name="BKMK_1"></a>Connection 对象
连接对象是一个 Active Directory 对象，它表示从源域控制器到目标域控制器的复制连接。 域控制器是单个站点的成员，并在站点中由 Active Directory 域服务 (AD DS) 中的服务器对象表示。 每个服务器对象都有一个子 NTDS 设置对象，该对象表示站点中的复制域控制器。

连接对象是目标服务器上的 NTDS 设置对象的子对象。 若要在两个域控制器之间进行复制，其中一个服务器对象必须有一个连接对象，该对象表示来自另一个的入站复制。 域控制器的所有复制连接都存储为 NTDS 设置对象下的连接对象。 连接对象标识复制源服务器，包含复制计划，并指定复制传输。

知识一致性检查器 (KCC) 自动创建连接对象，但也可以手动创建它们。 KCC 创建的连接对象会在 "Active Directory 站点和服务" 管理单元中显示为 **<automatically generated>** ，并且在正常操作情况下被认为是足够的。 管理员创建的连接对象是手动创建的连接对象。 手动创建的连接对象由管理员在创建时分配的名称标识。 修改 **<automatically generated>** 连接对象时，可将其转换为管理修改的连接对象，对象将以 GUID 的形式出现。 KCC 不会更改手动或修改的连接对象。

## <a name="kcc"></a><a name="BKMK_2"></a>KCC
KCC 是在所有域控制器上运行的内置进程，并为 Active Directory 林生成复制拓扑。 KCC 根据复制是在站点中 (站点内) 还是站点间)  (站点之间进行复制来创建单独的复制拓扑。 KCC 还动态调整拓扑，以适应新域控制器的添加、删除现有域控制器、在站点之间移动域控制器、更改成本和计划以及暂时不可用或处于错误状态的域控制器。

在站点中，可写域控制器之间的连接始终按双向环形进行排列，并且具有更多的快捷连接以减少大型站点中的延迟。 另一方面，站点间拓扑是跨越树的分层，这意味着每个目录分区的任意两个站点之间存在一个站点间连接，通常不包含快捷方式连接。 有关跨越树和 Active Directory 复制拓扑的详细信息，请参阅 Active Directory 复制拓扑技术参考 ([https://go.microsoft.com/fwlink/?LinkID=93578](https://go.microsoft.com/fwlink/?LinkID=93578)) 。

在每个域控制器上，KCC 通过创建定义来自其他域控制器的连接的单向入站连接对象来创建复制路由。 对于同一站点中的域控制器，KCC 会自动创建连接对象，而无需管理干预。 如果有多个站点，则需要在站点之间配置站点链接，每个站点中的单个 KCC 也会自动在站点之间创建连接。

### <a name="kcc-improvements-for-windows-server-2008-rodcs"></a>Windows Server 2008 Rodc 的 KCC 改进

为了适应新的可用只读域控制器，在 Windows Server 2008 中 (RODC) 提供了许多 KCC 改进。 RODC 的典型部署方案是分支机构。 此方案中最常用的 Active Directory 复制拓扑基于辐射型设计，其中，多个站点中的分支域控制器与中心站点中的少量桥头服务器一起复制。

在这种情况下，部署 RODC 的优点之一是单向复制。 桥头服务器不需要从 RODC 进行复制，这会减少管理和网络使用情况。

但是，在以前版本的 Windows Server 操作系统上，中心辐射型拓扑突出显示的一项管理挑战是，在中心内添加新桥头域控制器后，没有自动机制在分支域控制器和中心域控制器之间重新分发复制连接以利用新的中心域控制器。

对于 Windows Server 2003 域控制器，你可以通过使用 () 的 Windows Server 2003 分支机构部署指南中的工具 Adlb.exe 来重新均衡工作负荷 [https://go.microsoft.com/fwlink/?LinkID=28523](https://go.microsoft.com/fwlink/?LinkID=28523) 。

对于 Windows Server 2008 Rodc，KCC 的正常运行会提供一些重新平衡，从而无需使用其他工具（如 Adlb.exe）。 默认情况下，新功能处于启用状态。 可以通过在 RODC 上添加以下注册表项来禁用它：

**HKEY_LOCAL_MACHINE \SYSTEM\CurrentControlSet\Services\NTDS\Parameters**

**"允许随机 BH Loadbalancing"** 
**1 = 已启用 (默认) ，0 = 已禁用**

有关这些 KCC 改进工作原理的详细信息，请参阅规划和部署分支机构 Active Directory 域服务 ([https://go.microsoft.com/fwlink/?LinkId=107114](https://go.microsoft.com/fwlink/?LinkId=107114)) 。

## <a name="failover-functionality"></a><a name="BKMK_3"></a>故障转移功能
站点确保复制是围绕网络故障和脱机域控制器进行路由的。 KCC 按指定的时间间隔运行，以调整 AD DS 中发生的更改（例如，添加新域控制器和创建新站点）的复制拓扑。 KCC 检查现有连接的复制状态，以确定是否有任何连接不起作用。 如果某个连接由于域控制器故障而不工作，则 KCC 会自动建立与其他复制伙伴的临时连接 (如果可用) 确保发生复制。 如果站点中的所有域控制器都不可用，则 KCC 会自动在不同站点的域控制器之间创建复制连接。

## <a name="subnet"></a><a name="BKMK_4"></a>个子
子网是一段 TCP/IP 网络，其中的一组逻辑 IP 地址被分配。 子网通过一种方式对计算机进行分组，以便在网络上确定其物理邻近性。 AD DS 中的子网对象标识用于将计算机映射到站点的网络地址。

## <a name="site"></a><a name="BKMK_5"></a>站点
站点 Active Directory 是指一个或多个对象，这些对象代表一个或多个具有高度可靠和快速网络连接的 TCP/IP 子网。 管理员可以使用站点信息配置 Active Directory 访问和复制，以优化物理网络的使用情况。 站点对象与一组子网相关联，并且林中的每个域控制器都与 Active Directory 站点关联（根据其 IP 地址）。 站点可以托管多个域中的域控制器，并且一个域可以表示在多个站点中。

## <a name="site-link"></a><a name="BKMK_6"></a>站点链接
站点链接是表示 KCC 用于建立 Active Directory 复制连接的逻辑路径的 Active Directory 对象。 站点链接对象代表一组可通过指定的站点间传输以统一开销进行通信的站点。

站点链接中包含的所有站点都被视为通过相同网络类型进行连接。 站点必须通过使用站点链接手动链接到其他站点，以便一个站点中的域控制器可以从其他站点中的域控制器复制目录更改。 由于站点链接与在复制过程中物理网络上的网络数据包所采用的实际路径不对应，因此无需创建冗余站点链接来提高 Active Directory 复制效率。

当站点链接连接两个站点时，复制系统会自动在每个被称为桥头服务器的站点中的特定域控制器之间创建连接。 在 Windows Server 2008 中，承载相同目录分区的站点中的所有域控制器都是选择作为桥头服务器的候选项。 KCC 创建的复制连接会随机分发到站点中的所有候选桥头服务器中，以共享复制工作负荷。 默认情况下，在首次将连接对象添加到站点时，随机选择过程只发生一次。

## <a name="site-link-bridge"></a><a name="BKMK_7"></a>站点链接桥
站点链接桥是一个 Active Directory 对象，它代表一组站点链接，所有站点都可以使用通用传输进行通信。 站点链接桥使不是通过通信链接直接连接的域控制器可以相互复制。 通常，站点链接桥对应于一个路由器 (或一组路由器) 在 IP 网络上。

默认情况下，KCC 可以通过包含一些公共站点的所有站点链接形成可传递的路由。 如果禁用此行为，则每个站点链接都表示其自己的不同和隔离的网络。 可视为单个路由的站点链接集通过站点链接桥表示。 每个桥代表网络流量的隔离的通信环境。

站点链接桥是一种逻辑上表示站点之间的可传递物理连接的机制。 站点链接桥允许 KCC 使用所包含站点链接的任意组合来确定在这些站点中保存的连接目录分区的开销最少的路由。 站点链接桥并不提供与域控制器的实际连接。 如果删除了站点链接桥，则在 KCC 删除链接之前，会继续通过组合站点链接进行复制。

仅当站点包含的域控制器托管的目录分区不在相邻站点的域控制器上，而托管该目录分区的域控制器位于林中的一个或多个其他站点中时，才需要站点链接桥。 相邻站点定义为一个站点链接中包含的任意两个或更多站点。

站点链接桥在两个站点链接之间创建逻辑连接，并使用临时站点提供两个断开连接的站点之间的可传递路径。 为了使站点间拓扑生成器 (ISTG) ，桥指使用过渡站点进行物理连接。 桥并不意味着过渡站点中的域控制器将提供复制路径。 但是，如果临时站点包含托管要复制的目录分区的域控制器，则会出现这种情况，在这种情况下，不需要站点链接桥。

添加每个站点链接的成本，并为生成的路径创建一个总计成本。 如果临时站点不包含托管目录分区的域控制器，并且不存在较低成本的链接，则将使用站点链接桥。 如果临时站点包含托管目录分区的域控制器，则两个断开连接的站点将设置与过渡域控制器的复制连接，而不使用桥。

## <a name="site-link-transitivity"></a><a name="BKMK_8"></a>站点链接传递性
默认情况下，所有站点链接都是可传递的或 "桥接"。 当桥接站点链接并且计划重叠时，KCC 会创建复制连接，以确定站点之间的域控制器复制伙伴，其中的站点不直接通过站点链接进行连接，而是通过一组常用站点以可传递方式连接的。 这意味着你可以通过组合站点链接将任何站点连接到任何其他站点。

通常，对于完全路由的网络，除非要控制复制更改的流，否则不需要创建任何站点链接桥。 如果你的网络未完全路由，则应该创建站点链接桥，以避免复制尝试失败。 特定传输的所有站点链接都隐式属于该传输的单一站点链接桥。 站点链接的默认桥接会自动发生，并且没有 Active Directory 对象表示该桥。 " **桥接所有站点链接** " 设置，在 "IP" 和 "简单邮件传输协议" 的属性中， (SMTP) 站点间传输容器，实现自动站点链接桥接。

> [!NOTE]
> AD DS 的未来版本中将不支持 SMTP 复制;因此，不建议在 SMTP 容器中创建站点链接对象。

## <a name="global-catalog-server"></a><a name="BKMK_9"></a>全局编录服务器
全局编录服务器是一个域控制器，它存储林中所有对象的相关信息，以便应用程序无需引用存储所请求数据的特定域控制器即可搜索 AD DS。 与所有域控制器一样，全局编录服务器存储架构和配置目录分区的完全可写副本，以及它所托管的域的域目录分区的完全可写副本。 此外，全局编录服务器还存储林中每个其他域的部分只读副本。 部分只读域副本包含域中的每个对象，但只 (那些最常用于) 对象搜索的属性的子集。

## <a name="universal-group-membership-caching"></a><a name="BKMK_10"></a>通用组成员身份缓存
通用组成员身份缓存允许域控制器缓存用户的通用组成员身份信息。 可以通过使用 "Active Directory 站点和服务" 管理单元，启用运行 Windows Server 2008 的域控制器来缓存通用组成员身份。

启用通用组成员身份缓存后，就不需要在域中的每个站点上都需要全局编录服务器，这会将网络带宽的使用降到最低，因为域控制器不需要复制林中的所有对象。 它还可以减少登录时间，因为身份验证域控制器并不总是需要访问全局编录即可获取通用组成员身份信息。 有关何时使用通用组成员身份缓存的详细信息，请参阅 [规划全局编录服务器的放置](../../../ad-ds/plan/Planning-Global-Catalog-Server-Placement.md)。



