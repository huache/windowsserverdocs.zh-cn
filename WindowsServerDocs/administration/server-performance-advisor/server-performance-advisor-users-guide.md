---
title: Server Performance Advisor 用户指南
description: Server Performance Advisor 用户指南
ms.assetid: be99a5a9-b9c0-436b-912c-e5c5839a533d
ms.author: lizross
author: eross-msft
manager: mtillman
ms.date: 10/16/2017
ms.topic: article
ms.openlocfilehash: e09f4cbdd30aed8f14be449ed98fbc649ca58888
ms.sourcegitcommit: db2d46842c68813d043738d6523f13d8454fc972
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 09/10/2020
ms.locfileid: "89628327"
---
# <a name="server-performance-advisor-users-guide"></a>Server Performance Advisor 用户指南

>适用于： Windows Server (半年通道) ，Windows Server 2016，Windows Server 2012 R2，Windows Server 2012，Windows 10，Windows 8

此适用于 Microsoft Server Performance Advisor (SPA) 的用户指南提供了有关如何使用 SPA 来识别各种服务器角色中部署的系统的性能瓶颈的指导原则。

SPA 可帮助你执行以下操作：

* 管理服务器性能并解决服务器性能问题。

* 提供有关常见配置和性能问题的数据报告和建议。

* 提供基于收集的数据的最佳实践建议。

> [!NOTE]
> SPA 控制台不会对服务器进行任何更改。

有关开发 SPA 顾问包的详细信息，请参阅 [Server Performance Advisor Pack 开发指南](server-performance-advisor-pack-development-guide.md)。

## <a name="server-performance-advisor-overview"></a>服务器性能顾问概述


本部分介绍 SPA 的历史记录，描述其目标受众和方案，并提供该工具的体系结构概述。

### <a name="history-of-spa"></a>SPA 历史记录

Microsoft Server Performance Advisor 的原始版本 (SPA) 在2005-2006 中发布。 它主要针对 Windows Server 2003，包括核心操作系统和服务器角色，如 Internet Information Services (IIS) 和 active directory。 此工具的目标是帮助你评估服务器性能并解决服务器性能问题。

SPA 向系统管理员提供有关常见配置和性能问题的数据报告和建议。 SPA 收集服务器上不同源的与性能相关的数据，例如性能计数器、注册表项、WMI 查询、配置文件和 Windows (ETW) 的事件跟踪。 基于它收集的服务器性能数据，SPA 可以提供当前服务器性能情况的详细信息，并提供有关可改进的内容的建议。

原始的 SPA 工具已超过1000000个下载，并且它有助于许多系统管理员管理其服务器的性能。 这是一种非常成功的性能故障排除工具。

自初始 SPA 以来，服务器性能世界中存在一些重大更改。 最值得注意的是，版本的 Windows Server 2012 R2、Windows Server 2012、Windows Server 2008 R2 和 Windows Server 2008 都具有新版本的相应服务器角色，如 Internet Information Services (IIS) 8.5。 较新版本的服务器性能顾问将原始 SPA 的功能扩展到最新的服务器操作系统和服务器角色。

尽管 SPA 3.1 与原始工具共享相同的设计目标和性能分析范例，但它已被最新技术重新编写。 它还具有以下重要改进：

* 可以针对运行 Windows Server 2012 R2、Windows Server 2012、Windows Server 2008 R2 和 Windows Server 2008 的服务器执行分析。

* 支持远程分析功能，这允许 SPA 3.1 从中央控制台收集和分析数据，无需在要分析的服务器上安装代码。

* 使用用于数据分析和存储的 Microsoft SQL Server，这允许处理和存储大量数据。

* 将此工具与 Advisor 包分离。 每个服务器角色的性能分析逻辑都以 advisor 包的形式发布，可从工具中单独发布或更新。

* 提供在具有开放体系结构的 SQL 脚本中开发的顾问包。 非 Microsoft 方可以开发顾问包或扩展 Microsoft 现有的顾问包，以满足特殊需求。

* 支持并行比较报表的新功能，以及用于帮助您查找异常的趋势和历史图表。

* 提供一些功能，如修改、导入和导出阈值，有助于优化报表和通知，并与其他 SPA 用户共享这些 tunings。

* 支持多个项目，这些项目可用于对目标服务器进行分组。

* 提供从 SPA 控制台内定期进行的数据收集。

* 使用 Microsoft SQL Server (为高级用户) 启用自定义查询和报表生成。

* 自定义的 Windows PowerShell cmdlet 可用于 SPA

* 从 SPA 3.0 数据库导入和查看报表的向后兼容性

### <a name="target-audience"></a>目标读者

SPA 工具主要用于管理在各种服务器角色中少于100服务器的系统管理员。 支持工程师也可以使用它来收集性能数据并解决客户的性能问题。

SPA 提供帮助你解决性能问题的建议;但它基于可能不适用于您的特定服务器环境的假设。 通过 SPA 提供的建议应被视为建议。 我们期望 SPA 用户对系统配置、用例和系统优化对整体系统行为的影响有很好的了解。 系统管理员应确定是否应将 SPA 建议应用于其环境。

### <a name="what-s-new-in-spa-31"></a><a href="" id="what-s-new-in-spa-3-1-"></a>SPA 3.1 中的新增功能

SPA 3.1 中新增了以下功能和增强功能：

* Active directory Advisor 包帮助分析服务器 active directory 域服务服务器角色的常规性能。

* 支持开发人员在创建报表时将丢失的 ETW 事件通知警报添加到报表中，并在慢速或过度争用的磁盘上导致事件由于高频率日志记录而丢失

### <a name="target-scenarios"></a>目标方案

下面是 SPA 的目标方案：

* **服务器环境**

    SPA 设计为易于设置和维护。 它适用于使用1到100服务器的服务器环境。 如果尝试管理100多个服务器的性能，SPA 不会很好地扩展。 对于更大型或更复杂的环境，应考虑使用 System Center Operations Manager。

* **性能故障排除**

    可以使用 SPA 作为性能故障排除工具。 它提供了收集高级性能数据的功能，它对数据进行了全面的后处理，使您能够更好地了解其整体系统行为，并对任何异常进行标记。 当客户怀疑性能问题时，可以使用 SPA 来收集和分析来自服务器的性能数据。

    SPA 生成可查看的报表。 SPA 报表提供了一个通知列表，其中突出显示了潜在问题，并提供了包含服务器的各种性能索引、配置和设置的数据部分。 您可以使用此报表来确定具体的性能问题，并使用建议来查找该问题的解决方案。 可以将报表与在不同时间或由其他服务器生成的其他报表进行比较。 使用这种并排比较，可以确定基线法与异常行为之间的差异。

    **注意** SPA 并未设计为调试或计量工具。 此外，从服务器的角度来看，可以将其视为只读工具，而不会修改服务器配置。



* **性能索引监视**

    可以使用 SPA 来监视服务器的性能索引。 您可以选择在服务器上定期运行 SPA 来收集性能数据，然后运行趋势图或历史图表来找出异常。 您可以查看特定分析的报告，查找有关性能问题的详细信息，然后使用建议或其他报告数据来解决该问题。

### <a name="spa-architecture"></a>SPA 体系结构

SPA 数据收集逻辑基于 Windows 中称为性能日志和警报 (PLA) 的协议生成。 PLA 允许程序收集本地或远程服务器的性能数据，例如性能计数器、WMI 查询、ETW 跟踪、注册表项和配置文件。 当 SPA 在目标服务器上运行性能分析时，它将基于所选的特定 SPA 顾问包创建一个 PLA 数据收集器集。 Advisor 包包含要收集的数据源以及要在其中存储日志的文件共享。 SPA 数据收集仅存储单一用户帐户;PLA 使用的同一个用户帐户也用于写入日志。

SPA 使用 SQL Server 数据库来存储从目标服务器收集的性能日志。 SPA 将文件共享中的所有性能日志导入到数据库，然后使用每个 advisor 包内的数据分析逻辑来处理数据和生成报告。 Advisor 包分析从目标服务器收集的性能数据，并生成 SPA 报告。 有关生成 advisor 包的详细信息，请参阅 [Server Performance Advisor Pack 开发指南](server-performance-advisor-pack-development-guide.md)。

SPA 控制台用户界面和交互作为 SPAConsole.exe 的一部分生成。 可以使用控制台创建数据库、添加或删除 advisor 包、管理目标服务器、运行性能分析和查看性能报告。

SPA 控制台可在以下操作系统上运行：

* Windows 8.1

* Windows 8

* Windows 7

* Windows Server 2012 R2

* Windows Server 2012

* Windows Server 2008 R2

* Windows 2008 Server

在典型的业务应用程序中有三个层：表示层、业务逻辑层和存储层。 SPA 设计为控制台和数据库的两层产品。 控制台用作表示层，其中包含特定于进程的逻辑，数据库充当存储层和业务逻辑层。 控制台捕获用户输入，并控制数据收集、数据处理和报表生成的步骤。 SPA 不依赖于 Windows 系统服务。

下图显示了 SPA 系统的高级体系结构。 过程如下：

1.  从 SPA 控制台中，可以在指定的服务器上运行性能分析。

2.  收集性能数据时，目标服务器上的 PLA 会将日志写入到数据收集器集指定的文件共享中。

3.  在目标计算机上完成数据收集后，SPA 控制台将日志导入到 SQL Server 数据库中。

4.  控制台调用特定 advisor 包的数据处理逻辑。

5.  Advisor 包处理数据并调用 SPA Api，将记录插入到由 SPA 框架定义的系统报表表中。

6.  可以使用控制台中的报表查看器来查看生成的报表。 为帮助您解决性能问题，SPA 提供了三种类型的报表：单一报表、并排报表、趋势图表或历史图表。 有关报表的详细信息，请参阅 [查看报表](#bkmk-viewingreports)。

![spa 体系结构](../media/server-performance-advisor/spa-user-manual-architecture.png)

## <a name="getting-started-with-spa"></a>SPA 入门


### <a name="requirements"></a>要求

可在 Windows 8.1、Windows 8、Windows 7、Windows Server 2012 R2、Windows Server 2012、Windows Server 2008 R2 和 Windows Server 2008 上安装 SPA 控制台。 不支持在较早版本的 Windows Server 操作系统上运行 SPA。 SPA 在 x86 或 x64 上运行，但它不支持 IA64 或 ARM 体系结构。

SPA 是 Windows Presentation Foundation (WPF) 2.0 上构建的，它是 Microsoft .NET Framework 4 的一部分，因此需要 .NET Framework 4。

还需要在安装 SPA 的同一台计算机上安装 SQL Server 2008 R2 Express。 SQL Server 2008 R2 Express 是由 Microsoft 发布的免费数据库引擎。 你可以从 Microsoft 下载中心下载 Microsoft SQL Server 2008 R2 Express。 尽管我们建议 SQL Server 2008 R2 Express，但较新版本的 SQL Server 也可能与 SPA 兼容。

**注意** SPA 不包括作为 SPA 安装包的一部分 SQL Server 或 .NET Framework。 安装 Microsoft SQL Server 2008 R2 和 .NET Framework 4.0 后，建议在安装 SPA 之前先运行 Windows 更新。



由于用户可以使用 SPA 创建和管理数据库，因此用于运行 SPA 的用户帐户应具有与 SQL Server 相同的管理员特权。

### <a name="setting-up-spa"></a><a href="" id="bkmk-setupspa"></a>设置 SPA

SPA 打包为一个 .cab 文件，其中包含 SPA 框架的所有二进制文件、在高级方案中使用的 Windows PowerShell cmdlet 和以下顾问包：核心操作系统、Hyper-v、active directory 和 IIS。 将 .cab 文件解压缩到文件夹后，无需进行其他安装。 但是，若要运行 SPA，需按如下所示启用目标服务器中的数据收集：

* 若要运行 PLA 数据收集，用于运行 SPA 控制台的用户帐户必须是目标服务器上 "管理员" 安全组的一部分。 如果目标服务器和控制台位于同一域中，则域用户帐户必须是目标服务器上 "管理员" 安全组的成员。 如果目标服务器和控制台不在同一个域中，请在目标服务器上创建一个管理用户帐户，该帐户的用户名和密码与运行 SPA 控制台所用的用户帐户相同。

* 为服务器上的结果创建一个共享文件夹。

* 确保用于运行 SPA 控制台的用户帐户对共享文件夹具有读取和写入权限。 PLA 使用此帐户将日志写入文件夹。
SPA 控制台使用同一帐户来读取日志并将它们导入到数据库中。

    **注意** ETW 实现了一个循环缓冲区来存储跟踪，并在可能时将其移动到共享文件夹。 如果服务器繁忙或写入操作速度较慢，则 ETW 会在缓冲区已满时删除跟踪。 共享文件夹位于具有快速 i/o 访问的服务器上，这一点很重要。 建议每个目标服务器都有一个共享文件夹，以最大程度地减少因文件 i/o 缓慢导致的数据丢失。



* 对于用于访问目标服务器的 PLA，请在目标服务器上设置 Windows 防火墙以允许远程性能日志和警报访问。 PLA 使用 TCP 端口139。

* 请确保 **性能日志 & 警报** 服务正在运行。

* 如果控制台和目标服务器位于不同的子网中，则还需要在 "**性能日志和警报**" 页上的 "**作用域**设置" 中的 "入站防火墙规则" 中设置 "远程 IP 地址" 字段，如下所示。

    ![pla 属性](../media/server-performance-advisor/spa-user-manual-pla-firewall.png)

* 在控制台和每个目标服务器上启用 "网络发现"。

* 如果目标服务器未加入域，请启用以下注册表设置： **HKLM \\ SOFTWARE \\ Microsoft \\ Windows \\ Currentversion \\ 策略 \\ 系统 \\ LocalAccountTokenFilterPolicy**。

**注意** 默认情况下，SPA 会将诊断日志写入 SpaConsole.exe 所在的文件夹中。 如果 SPA 安装在 Program Files 文件夹下，只在以管理员身份运行 SpaConsole.exe，SPA 才能写入日志。

如果要对控制台计算机运行数据分析，则需以管理员身份运行 SPA。 当在本地计算机上运行时，PLA 会经历不同的代码路径，这需要管理员特权。

如果要对服务器运行 IIS SPA 顾问包，则需要为 IIS 服务器启用 WMI 查询和 ETW 跟踪。 为此，可以在 "**运行状况和诊断**" 角色服务下启用**跟踪**，然后在 " **Web 服务器 (iis) **服务器" 角色下的 "**管理工具**" 下启用**iis 管理脚本和工具**。



### <a name="creating-your-first-project"></a>创建您的第一个项目

完成所有设置后，可以创建第一个 SPA 项目。 如上一节所述，SPA 存储了与数据库内的性能数据分析相关的所有内容。 每个 SPA 项目都对应一个数据库。 **第一次使用向导**将指导您完成以下步骤。

**创建 SPA 项目**

1.  启动 SpaConsole.exe。 控制台进入断开连接模式，其中 SPA 未连接到任何数据库，并且主窗口为空。

2.  若要创建新项目，请单击 " **文件**"，然后单击 " **新建项目**"。 这将启动 "首次使用" 向导。 第一页显示使用该向导时遵循的步骤：

    * 创建数据库

    * 设置顾问包

    * 向目标服务器列表中添加服务器

3.  单击“下一步”。  " **创建项目数据库** " 页要求您提供要在其中创建数据库的 Microsoft SQL Server 实例的名称。 例如，如果它与控制台位于同一台计算机上，则可以使用您的** \\ &lt; SQL server 名称 &gt; localhost**。

    **注意** SQL Server 2008 R2 Express 安装的默认实例名称为 SQLExpress。 对于安装在本地计算机上 SQL Server 2008 R2 Express 的实例，数据库通常默认为 **localhost \\ SQLExpress**。 但是，在 SQL Server 安装过程中，它可能已更改，因此需要确保使用正确的 SQL Server 实例名称。



4.  提供数据库名称。 仅允许使用字母、数字和下划线 (\_) 作为数据库名称的有效字符。 SPA 数据库名称的合理建议是 **spa**。 如果输入的名称无效，则会显示红色错误图标。 关联的工具提示提供验证失败的原因。

    **注意** 务必记住数据库名称和服务器实例名称，因为这些是项目的唯一标识符。 如果要切换到此数据库，则需要提供此信息。



5.  提供服务器实例名称和数据库名称后，第一次使用向导会生成数据库文件的位置。

6.  在 " **创建项目数据库** " 页上，单击 " **下一步**"。 第一次使用时，向导将创建一个数据库，并在数据库中生成所有与 SPA 相关的数据库架构、函数和存储过程。 此步骤可能需要几秒钟的时间，具体取决于硬件和网络速度。

    **注意** 如果此步骤失败，将显示一条错误消息。 其中一些常见问题包括：控制台无法连接到 SQL Server 实例、权限不足，无法创建数据库，或者数据库名称已经存在。



7.  上一步骤成功后，将看到 " **设置顾问包** " 页面。 其中列出了您的计算机上可用的所有 advisor 包。 SPA 会自动扫描 SPA 根目录下名为 " **ap** " 的文件夹。 其中列出了每个 advisor 包的完整名称、版本和作者。

    **注意** 有关完整名称和版本在 SPA 中的使用方式的详细信息，请参阅 [管理 advisor 包](#bkmk-manageadvisorpacks)



8.  选择要在项目数据库中预配的 advisor 包，然后单击 " **下一步**"。 也可以单击 " **跳过** " 移动到下一步，无需预配任何 advisor 包。

    **注意** 随时都可以使用该工具设置 advisor 包。 有关详细信息，请参阅 [管理 advisor 包](#bkmk-manageadvisorpacks)。



9.  在 " **添加服务器** " 页上，对于要添加到目标服务器列表中的每个服务器，需要填写以下两个必需字段： **服务器名称** 和 **文件共享位置**。

    **注意** 还有一个 **注释** 字段，该字段主要用于分类或查找服务器。 在具有多个服务器的情况下，您可以导入逗号分隔值 ( .csv) 文件，其中包含服务器名称、结果文件夹和可选的注释字段。 " **注释** " 字段用于描述服务器，术语可用于筛选用于数据收集的服务器。 如果通过 .csv 文件初始化服务器，则文件中的分析错误不会加载服务器。



10. 若要启用 PLA 数据收集，需要设置多个配置，如 [设置 SPA](#bkmk-setupspa)中所述。 " **添加服务器** " 页提供了测试配置功能，可帮助你解决配置问题。 选中与计算机关联的复选框，然后单击 " **测试连接**"。 SPA 尝试在目标服务器上生成数据收集器集，并尝试将结果导入回数据库。 如果所有内容都正确，则 **状态** 将显示 " **通过**"。 如果该操作失败，则会出现一个工具提示，描述失败的原因。

11. 即使服务器未通过配置测试，也会自动将每个服务器添加到数据库中。 若要从列表中删除服务器，请选择服务器名称，然后单击 " **删除**"。

12. 完成所有操作后，单击 " **完成** " 关闭第一次使用向导。 如果在完成前第一次使用向导时将其关闭，则所有前面的步骤都将保留，并且它们都不会自动回滚。 你需要手动进行将来的更改。

## <a name="running-analysis"></a>正在运行分析


设置数据库后，可以在服务器上运行性能分析。

每次启动 SPA 控制台时，当前用户使用的最后一个项目将自动打开。 主窗口包含服务器的列表。 每个服务器都有四个属性：服务器名称、分析结果、当前状态和注释。

* **服务器名称** 服务器的名称，它是服务器的标识符。 不允许使用重复的名称。

* **分析结果** 默认情况下，它显示针对服务器的最新性能分析的结果。 如果未对服务器运行任何性能分析，则不会显示任何 **报表**。 如果报表引发了警告，则会在生成最新报表时显示 **警告** 和时间戳。 如果在服务器上的最新分析过程中未发现任何问题，则会显示 **"正常"** 和 "时间戳"。

    **注意** 如果您最近更改了系统设置，我们建议您再次运行分析以评估更改的整体影响，并获得系统状态的更新报告。 SPA 不跟踪对所测试系统的配置更改。



* **当前状态** 显示服务器上当前正在运行的性能分析任务的状态。 可以通过单击 " **取消** " 图标来取消正在运行的任务，该图标由红色 X 指定。

* **批注** 描述当前目标服务器。 例如，你可以使用服务器角色来描述服务器 (例如 SQL Server ) 或 (位置例如，Kent ) 。 SPA 使用 **服务器名称** 和 **备注** 来帮助搜索和查找正确的服务器。 您可以在 "搜索" 文本框中键入。 如果 " **服务器名称** " 或 " **备注** " 列包含在搜索框中输入的确切字符串，则服务器将显示在 "服务器" 列表中。

控制台上还提供了以下控件：

* **重复** 描述根据时间间隔定期重复收集的功能的复选框。 对于大多数服务器安装，你需要将 SPA 集合重复每小时一次，以提供足够的分析历史记录。 如果只想运行集合一次，则不应选中 " **重复** " 复选框。

* **删除重复** 项一个按钮，可用于取消正在进行的重复收集作业。 如果任何) 正在进行中，它将取消重复集合，但不会取消当前集合 (。 此选项允许您重置新的重复收集间隔或手动运行该集合。

开始性能分析之前，请选择 "数据收集持续时间"。 尽管收集更多数据可以帮助提供更准确的服务器性能情况的映像，但它还会生成更多的日志，并且它可能会对服务器产生更大的潜在影响。 根据特定需求选择适当的数据收集持续时间。 每个顾问包都定义了最短有效持续时间。 选择的数据收集持续时间必须长于所选 advisor 包的最小持续时间。

若要在目标服务器上运行性能分析，请选择要对其运行性能分析的服务器，然后单击 " **运行分析** " 对话框，并要求选择要在服务器上运行的 advisor 包。 所选 advisor 包同时运行。 生成的报表基于在同一时间段内收集的性能数据。

**注意** 如果您选择了一个运行定期性能分析的服务器，则 " **删除重复周期** " 按钮允许您取消重复数据收集。 SPA 不允许在同一台计算机上同时执行多个数据收集会话。



## <a name="viewing-reports"></a><a href="" id="bkmk-viewingreports"></a>查看报表


在 SPA 中，有三种类型的性能分析报表：单一报表、并排报表、趋势图和历史关系图。

运行性能分析后，将为在目标计算机上运行的每个 advisor 包生成一个报表。 在主窗口的 "服务器" 列表中，您可以展开 " **分析结果** " 以查看在特定服务器上运行的所有 advisor 包。 您可以单击报表名称以查看单个报表。

Advisor 包名称旁有三个图标，用于显示服务器上的最新分析运行状态：

* **最新**图标显示了此服务器上针对 advisor 包的最新性能分析生成的报表。

* " **查找** " 图标将显示性能分析报表的列表，您可以在其中选择正确的报表。 " **Advisor 包** " 和 " **目标服务器** " 字段预先填入当前 Advisor 包和目标服务器信息。 默认时间范围设置为一周，结束日期设置为今天。 如果单击右上角的 " **搜索** " 按钮，则可以获取所选服务器的所有性能分析报表和该时间范围内的 advisor 包的列表。

* " **查看图表** " 图标打开 "趋势和历史图表" 视图。

下图显示了每个 advisor 包后的 **最新**、 **查找**和 **查看图表** 图标：

![报表图标](../media/server-performance-advisor/spa-user-manual-report-icons.png)

### <a name="searching-for-and-within-reports"></a>在报表中搜索和

使用 **报表资源管理器**来搜索报表。 这使你可以按日期范围、服务器名称和顾问 pack 搜索报表。 这是查找其他感兴趣的报表的建议方法，而不是上次运行的报表。 上次运行的报表可通过该服务器的 " **查看报表** " 获得。

查看特定报表时，可以轻松地按时间导航到下一个和上一个报表，或查看相关报表，例如同时运行的不同 AP。 这些选项在 " **操作**" 下提供。

还可以在报表中进行搜索。 许多报表都有一个 " **查找** 字符串" 搜索框，可用于在报表中搜索快速文本字符串。 若要删除文本框，您可以将其关闭。 若要在) 文本搜索的 windows 中激活搜索框 (，可以使用 Control + F 快捷方式。 使用 " **查找** " 框，用户可以根据 "区分 **大小写** " 选项指定区分大小写的搜索。

下图显示了 "**报表**" 选项卡上带有字符串**功能**的 "**查找**" 搜索框。

![查找搜索框](../media/server-performance-advisor/spa-user-manual-find-search-box.png)

### <a name="single-report"></a>单个报表

单个报表显示一台计算机上一次运行一次 advisor 包的性能分析结果。 该报表显示顾问包的名称、目标服务器的名称、生成报表的时间和数据收集的持续时间。

单个报表包含通知部分和数据部分。

### <a name="notification-section"></a>通知部分

"通知" 部分包含一组性能分析规则。 每个通知都包含一些数据源、一些阈值和一些业务逻辑。 运行性能分析时，业务逻辑会根据阈值计算数据源，以确定是否通过了规则。 否则，会显示一条警告，通知你潜在的性能问题。 它还提供有助于解决此问题的建议。 通知部分始终是单一报表视图中的第一个选项卡。

通知部分分为两部分： **警告** 和 **其他通知**。

如果规则的数据源满足某些基于逻辑和阈值设置的条件，则**警告区域中会出现警告。** 警告包括以下部分：

* 警告图标指示存在潜在问题。

* 规则的名称。 例如， **网络接收数据包删除** 是指向规则详细信息页的链接，如 [管理 advisor 包](#bkmk-manageadvisorpacks)中所述。

* 有关潜在问题的简单说明。

* 针对潜在性能问题的可能解决方案的建议。

不同的服务器可以有明显不同的配置和使用模式，并且不可能设置适用于所有情况下的所有服务器的阈值和规则。 SPA 提供了修改阈值的功能。 如果规则不适用于你的方案，你还可以选择禁用规则。 默认情况下，所有规则均已启用。 禁用的规则不会显示在通知区域中。 有关详细信息，请参阅 [管理 advisor 包](#bkmk-manageadvisorpacks)。

**其他通知**区域包含所有其他规则，其中不会发出警告或规则不适用。 它包含 " **警告** " 区域中的相似部分。 最大的区别是，如果未引发警告或规则不适用，则通常不会提供建议。

### <a name="data-sections"></a>数据部分

数据节包含顾问包基于从目标服务器收集的原始数据生成的性能数据。 数据部分包括一组顶级部分和多个级别的子节。 顶级部分显示为选项卡。 顶级部分下的所有子部分都显示在可扩展区域中。 您可以折叠或展开每个部分，以帮助重点关注感兴趣的区域，如下图所示。

![数据部分](../media/server-performance-advisor/spa-user-manual-data-sections.png)

核心操作系统 SPA 顾问包和 IIS SPA 顾问包包含 **系统概述** 部分。 本部分包括有关资源使用情况和配置的顶级信息。 其他顶级部分表示性能数据的区域。 SPA 以下列方式呈现报表数据：

* **单个值** 键/值对。 该键是一个字符串，它表示值的含义。 值可以是字符串、数值或布尔值。 这通常用于显示静态信息，如配置、CPU 体系结构、总内存大小和 BIOS 版本（不随时间变化）。

* **列表值** 这有时是键/值对，但列表值可以包含多个字段。 例如，可以在具有多个列和多个行的表中显示 CPU 的属性。 每一行代表一个 CPU，每个列表示 CPU 的一个属性。

* **统计信息** 可以被视为一种特殊类型的单个值。 它只能包含数值数据。 在数据收集期间，许多数值数据点会波动，而不是保持不变。 例如，每次 PLA 收集性能计数器时，CPU 使用率都会发生变化。 仅显示单个值无法准确反映性能情况。 对于此类动态数值数据点，而不是仅显示一个值、平均值、最小值、最小值和90%。 90% 值表示位于给定收集间隔内该计数器的所有事件的90% 的活动位置或更高。

* **顶部列表** 通常包含特定资源的排名靠前的使用者或遇到某些事件的顶级实体。 例如， **在平均 cpu 使用率方面，前10个进程** 包括在数据收集过程中 CPU 使用率最高的前十个进程。 由于 CPU 使用率也是动态数值数据点，因此列表中还包含其他统计信息（例如最大值、最小值和90%），以便为用户提供更完整的 CPU 消耗。

如前面部分所述，SPA 依赖于 PLA 收集 ETW 跟踪、WMI 查询、性能计数器、注册表项和配置文件以生成报表。 了解报表中每个数据点后面的数据源很重要。 SPA 通过工具提示提供此类信息。 您可以将鼠标悬停在键列或行上，以查看数据源工具提示。 例如， **wmi： Win32 \_ DisDrive： Caption** 表示数据源来自 WMI 查询，wmi 类名称为 Win32 \_ DiskDrive，属性为 **Caption**。

### <a name="side-by-side-report"></a><a href="" id="side-by-side-report-"></a>并排报表

单个报表提供通知和数据部分来帮助用户发现潜在的性能问题，但通常很难通过直接查看单个报表来确定潜在的性能问题。 单个报表可能包含太多数据点，这使得难以找到潜在问题。

为了解决此问题，SPA 提供比较两个报表的功能。 您可以将报表与基线报表进行比较，以帮助查找不同之处。

并行报表可以从单报表查看器启动。 用户可以单击 " **操作**"，然后单击 " **比较报表** " 来选择报表。 它仅用于比较同一个 advisor 包中的报表。 您可以选择将报表与以前的报表时间、下一个报表时间或通过搜索功能选择的任意报表进行比较。 例如，若要隔离异常行为，可以将基线服务器报表与在同一台计算机上的不同时间生成的报表进行比较，或将其与在具有相似服务器角色和负载的其他计算机上生成的报表进行比较。

并排报表与单个报表大致相同。 它包含通知部分和数据部分。 它包含与单个报表查看器相同的通知数和数据部分。 唯一的区别是报表以并排方式显示。 每节包含来自源报表 (报表 1) 的数据，以及 (报表 2) 的目标报表。并行报表显示顾问包的名称、目标服务器的名称 (在左侧显示报表1，在右侧) 报表2，生成报表的时间，以及每个报表的数据收集的持续时间。

如果关闭 " **查找** " 对话框，则可以通过键入 Control + F 来重新激活它。此对话框查找并突出显示当前部分中的文本字符串。

在 "通知" 部分中，如果所比较的两个报表中的任何结果是警告，则会在 **警告** 区域中列出。 否则，结果将在 " **其他通知** " 区域中列出。 由于并排报表的键是标识报表之间的差异，因此不会显示有关规则的详细信息。 用户可以单击规则名称以显示规则详细信息窗体以获取有关规则的详细信息。

在 "数据" 部分中，数据以并排方式显示，其中显示了左侧的报表1中的数据和右侧报表2中的数据。 SPA 显示同一个表中的单个值，而不是对列 **值**进行标记，而不是将它们分别命名为 **报表 1** 和 **报表 2** 。 并排报表显示并行表中的所有其他形式的数据。

并排报表查看器还提供有关数据源的工具提示。

### <a name="historical-and-trend-charts"></a>历史结构图和趋势图

只有显示特定服务器和特定 advisor 包的趋势和历史图表才有意义。 你需要选择 (默认为最后一周) 的时间范围，然后单击 **"确定"** 以显示趋势和历史图表查看器。

趋势图和历史图表查看器有三个选项卡：历史图表、24小时趋势图和7天趋势图。

### <a name="historical-chart"></a>历史图表

历史图表显示了一系列在给定时间范围内数值数据点的值。 例如，过去15天单台服务器上 IIS 的 **平均请求延迟** 。 历史图表中的每个数据点都表示一个性能分析会话中创建的特定数据源的值。

有几种使用历史图表的方法：

1.  若要帮助在特定时间为数据点查找异常，例如，每日凌晨2:00，则 IIS 跳转的 **平均请求延迟** 约 200 ms 到 500 ms。

2.  有助于关联多个数据点。 例如，显示过去15天的 **平均请求延迟** 和 **平均请求计数** 。 报表可能会显示请求延迟和请求计数在同一时间点增加，这可能表明请求延迟增加是由请求计数增加导致的。

在历史图表中，用户可以执行以下操作：

* 在图表区中显示多个数据序列。 每个数据序列在报表查看器中显示为折线图。 每个折线图会自动缩放以适应报表查看器。

* 在历史图表查看器底部的 "数据序列" 列表中添加或删除数据序列。

* 显示或隐藏 "数据序列" 列表中的数据系列。 用户可以单击列表中的特定数据系列，以突出显示图表区中相应的折线图。

* 通过选择图表区内的时间段来放大特定时间段。 若要缩小，请单击位于图表左下角的按钮。

* 通过双击特定数据点来调查单个报表。

* 复制数据并使其可用于其他程序（如 Microsoft Excel）。 这样，你就可以根据需要使用 Microsoft Excel 图表功能。

### <a name="trend-charts"></a>趋势图

许多重复的性能问题都是由在或针对目标服务器运行的定期任务导致的。 例如，面向娱乐的网站可能会在周末获得更多的点击，或计划磁盘备份任务可能会在每天凌晨2:00，降低服务器的性能。

趋势图旨在帮助您找到此类性能问题。 在各种模式中可能重复出现性能问题。 最常见的模式是日常模式和每周模式，在这种情况下，会在一天中的同一小时或一周中的某一天发生性能问题。 因此，SPA 提供24小时趋势图和7天趋势图。

趋势分析关系图对一组数据进行了更深入的调查，并根据一天中的时间来查找趋势。 X 轴设置为24小时期间，从 0:00 (午夜开始) ，到23:59 结束。 SPA 不会同时显示多个数据序列的趋势。 您可以单击 " **选取数据序列** " 以选择要查看的数据系列。

为了处理数据，SPA 将查找每小时在0:00 到0:59 之间拍摄的所有快照。 SPA 确定在该小时内拍摄的快照集的最小值、最大值、平均值和 sigma 值，并将这些值作为 k 线图图图形化。 SPA 为在1:00 到1:59 之间拍摄的快照重复此过程，然后为2:00 为2:59，依此类推。 如果给定小时的快照不存在，SPA 会将该小时保留在图形上，并继续到下一小时。

7天趋势图非常类似于24小时趋势图。 唯一的区别在于，它基于一周中的某一天而不是一天中的某一天对数据序列进行分组。

您在 "趋势" 和 "历史" 图表中选择的数据序列将存储为用户首选项。 下一次为同一 advisor 包打开趋势和历史图表查看器时，将列出相同的一组数据序列作为默认值。

## <a name="managing-reports"></a>管理报表


### <a name="deleting-reports"></a>删除报表

可以删除报表以最大程度地减少需要由 SPA 管理的报表的数目。 建议删除不必要的报表，具体取决于报表的频率和服务器的数量。 尽管 SPA 对可管理的报表没有限制，但基础数据库可能有大小限制。

**注意** 删除的报表不能撤消删除。



### <a name="exporting-and-importing-reports"></a>导出和导入报表

可以将报表导出到 XML 文件，以传输到其他 SPA 控制台或通过电子邮件发送给其他用户。 导出报表不会删除该报表。 若要导出当前查看的报表，请在 **报表查看器**中单击 " **操作**"，然后单击 " **导出**"。 若要导出多个报表，请从 **报表资源管理器**中单击 " **启用多个选择**"，从选择框中选择多个报表，然后单击 " **导出**"。 这会将 XML 格式的报表导出到所选的目标目录中。

可以使用 SPA 查看导出的报表。 导入的报表不会添加到 SPA 数据库中。 它们主要用于作为导出报表的 XML 查看器应用程序。 导入的报表的服务器不需要安装与原始导出的报表 SPA 控制台相同的 advisor 包。

## <a name="managing-advisor-packs"></a><a href="" id="bkmk-manageadvisorpacks"></a>管理顾问包


SPA 包括核心操作系统、Hyper-v、active directory 和 IIS 的顾问包。 SPA 为使用 SQL 开发顾问包提供了开放式体系结构，因此，非 Microsoft 开发人员也可以生成 advisor 包的版本。 有四个选项可用于管理顾问包：预配、自定义、重置或删除。

### <a name="provision-new-advisor-packs"></a>预配新的顾问包

Microsoft 或非 Microsoft 开发人员可以发布新的顾问包。 Advisor 包包含一个 provisionMetaData.xml 和一组用于描述逻辑的 SQL 脚本。

**预配新的顾问包**

1.  将 advisor 包的所有内容复制到 *% SpaRoot%* \\ ap 目录下。

2.  在主窗口中，单击 " **配置**"，然后单击 " **配置 Advisor 包**"。 此时将打开 " **配置顾问包** " 对话框。

    **注意** 此对话框类似于首次使用向导时的 " **设置顾问包** " 页面。 它显示可用于管理的顾问包的列表。 列表中的每个 advisor 包都具有属性，如名称、已安装版本、版本和作者。 Name 是 advisor 包的完整名称，已安装的版本是已在项目中预配的此 advisor 包的版本。 如果未在当前数据库中预配 advisor 包，则 "已安装版本" 文本框将显示 " **未安装**"。 "版本" 字段指示此 advisor 包的版本，该版本将在 "advisor 包" 文件夹下进行归档。



3.  从列表中选择 "advisor 包"。 如果尚未设置 advisor 包或者 advisor 包文件夹中的版本比数据库中的版本新，则会启用 " **设置** " 按钮。 单击 " **设置** " 按钮。

4.  预配完成后，所选 advisor 包的 " **已安装的版本** " 字段将包含新的版本信息。

### <a name="customize-advisor-packs"></a>自定义顾问包

SPA 定义了允许用户修改 advisor 包的开放体系结构。 用户可以通过更改阈值、共享阈值以及启用或禁用规则来修改 advisor 包文件。

有关如何更改和构建 advisor 包的详细信息，请参阅 [Server Performance Advisor Pack 开发指南](server-performance-advisor-pack-development-guide.md)。

### <a name="changing-thresholds"></a>更改阈值

在 SPA 中使用阈值来确定是否满足规则的触发条件。 由于工作负荷、硬件环境和业务需求的原因，实际客户方案的实际阈值可能会很大变化。 对于当前用户情况，默认阈值可能不正确，因此 SPA 提供了修改现有阈值的功能。

您可以通过在单个或并排报表中单击规则名称来修改阈值。 或者，若要管理特定 advisor 包的所有规则，可以在 " **配置** " 菜单中修改 "阈值"。

**更改阈值**

1.  在 " **配置** " 菜单中，单击 " **配置顾问包**"，单击要修改的顾问包的名称，然后单击 " **配置**"。

    **注意** 将显示一个列表，其中包含 advisor 包中包含的所有规则。 Advisor 包名称左侧的复选框指示是否启用了该规则。 如果禁用某一规则，则会在所有报表中隐藏该规则。



2.  单击要修改的特定规则。 此时会打开所选规则的 " **规则详细信息** " 窗体。

规则详细信息窗体包含有关特定规则的详细信息。 它包括名称、描述、状态、可能的结果和阈值。 SPA 支持两种类型的规则结果： " **警告** " 和 **"确定"**。 对于每种类型，都有建议文本和建议。

某些规则没有定义的阈值。 例如，" **HTTP 保持活动** " 规则检查 IIS 的布尔值设置。 因此阈值列表可能为空。 否则，将列出当前规则使用的所有阈值。 有关如何在规则中使用阈值的详细说明包含为说明的一部分。

如果从 "**配置**" 菜单中启动 "**规则详细信息**" 窗体，则 "阈值" 列表包含三列： "名称"、"原始设置" 和 "更改设置"。 如果它是从单个或并排的报表启动的，则还会包括该报表使用的阈值。 用户可以通过更改 " **更改设置** " 列中的值，然后单击 " **保存** " 将更改保存到数据库来修改当前阈值。

对阈值做出的所有更改仅适用于在更改后生成的报表。 这些更改不会影响现有的报表。

### <a name="sharing-thresholds"></a>共享阈值

如果在类似情况下管理服务器，则可以选择使用相同的阈值集。 您可以使用 " **配置** " 菜单来导出和导入特定 advisor 包的阈值。 您可以选择特定的顾问包，然后单击 " **配置**"。 导出的阈值文件采用 XML 格式。

导入阈值时，SPA 将验证 XML 文件格式，并验证该文件是否与所选 advisor 包匹配。 如果成功，SPA 会将阈值文件中的所有值导入到当前项目数据库。 与先前变化的阈值方案类似，所有阈值的更改仅对将来生成的报表生效。 现有报表不受影响。

### <a name="enable-or-disable-rules"></a>启用或禁用规则

可以从 " **规则详细信息** " 窗体启用或禁用规则。 你需要单击 " **保存** " 以保存所做的更改。 如果规则被禁用，则不会显示在任何报表中。 但在生成报表时将触发基础业务逻辑，因此，当你选择重新启用规则时，它会再次显示在报表中。

### <a name="reset-advisor-packs-to-original-state"></a>将 advisor 包重置为原始状态

您可以决定在数据库中修改预配的 advisor 包。 除了更改阈值之外，您还可以更改 SQL 脚本。 SPA 不支持更改报表元数据，也不支持添加或删除预配的顾问包的规则。 手动修改这些区域可能会导致意外的行为。

有关更改预配的顾问包的详细信息，请参阅 [服务器性能顾问包开发指南](server-performance-advisor-pack-development-guide.md)。

如果要回滚对预配的顾问包所做的更改，则可以选择重置 advisor 包。 这会覆盖所有与 advisor 包相关的 SQL 脚本并重置所有默认阈值。 这会保留所有现有报表。

可以使用 " **配置顾问包** " 窗体来重置 advisor 包。 需要选择要重置的 advisor 包，然后单击 " **重置**"。

### <a name="remove-advisor-packs"></a>删除 advisor 包

当不再需要 advisor 包时，用户可以将其从数据库中删除。 删除 advisor 包将从数据库中删除有关 advisor 包的所有内容，包括规则和阈值、所有 SQL 脚本以及所有报表。 不能回滚任何操作。

删除 advisor 包可以使用 " **配置顾问包** " 窗体完成。 需要选择要删除的 advisor 包，**然后单击 "取消设置"。**

### <a name="update-existing-advisor-packs"></a>更新现有顾问包

更新现有的顾问包非常类似于将 advisor 包重置为其原始状态。 若要将 advisor 包更新到较新的版本，请将新的 advisor 包复制到 advisor 包文件夹中。 仅当未更改报表元数据时，才会将 advisor 包视为对现有 advisor 包的更新。 报表和规则 Id 必须相同。 否则，应将它们视为两个不同的顾问包。

如果只有业务逻辑发生更改，并且没有针对 advisor 包的报表元数据更改，则应为其提供新的版本号，例如1.0 到2.0。 如果报表元数据发生更改，则应为 advisor 包提供不同的全名。 例如，可以将 ServerPerformanceAdvisor 更改为 ServerPerformanceAdvisor. 2. 2。

如果存在较新版本的 advisor 包，则 " **配置顾问包** " 窗体中的列表会自动使用最新版本的 advisor 包填充 " **版本** " 列。 你可以选择 "advisor 包"，然后单击 " **重置**"。 Advisor 包将更新为新的业务逻辑和阈值。 此 advisor 包的所有报表都将保留。

## <a name="managing-servers"></a>管理服务器


SPA 为管理目标服务器提供基本功能。 您可以选择将新服务器添加到目标服务器列表中，从列表中删除服务器，或者修改服务器的备注。

**添加或删除服务器或修改服务器信息**

1.  单击 " **配置** " 菜单，单击 " **配置服务器**"。

2.  在项目数据库中当前存在的服务器列表中，最后一行是空的。 单击该行并填写字段。 **服务器名称**和**文件共享位置**文件夹字段是必需的，并且服务器名称必须是唯一的。

3.  在每个服务器的 " **备注** " 列中输入其他服务器信息。

    **注意** 此字段使用自由文本格式，因此可将其用作说明字段。 或使用此字段对服务器进行标记，以便可以在主窗口中轻松地找到这些服务器或对服务器进行分组（例如，按位置或服务器角色）。



4.  如果要将 SPA 用于大量服务器，SPA 支持以逗号分隔的值 ( .csv) 格式进行导入。 文件必须至少包含两个字段： **服务器** 和 **文件共享位置**。 第三个字段 **是可选的，但** 建议对服务器进行组织。 您还可以将服务器列表导出到 .csv 文件，以确定适当的格式或备份您的服务器配置。

### <a name="searching-and-filtering"></a>搜索和筛选

如果管理多个服务器，SPA 会提供基本支持，以便在主窗口中快速找到服务器。 可以单击列标题，根据服务器名称、分析结果、当前任务状态或备注进行排序。 你还可以选择使用搜索功能。 在主窗口的右上角，可以键入要搜索的字符串。 主窗口中的 " **目标服务器** " 列表使用字符串筛选服务器，并且仅显示名称或注释字段包含搜索字符串的服务器。

下图显示了字符串**dell**如何将服务器与包含**dell**的 "**注释**" 字段**的字符串相**匹配。

![搜索和筛选示例](../media/server-performance-advisor/spa-user-manual-find-search-example.png)

## <a name="advanced-functionality"></a>高级功能


### <a name="working-with-spa-windows-powershell-cmdlets"></a>使用 SPA Windows PowerShell cmdlet

SPA 控制台支持通过 UI 进行定期数据收集。 如果该功能不足以满足您的环境要求，则可以使用 Windows PowerShell cmdlet 来自定义数据收集。 使用这些 Windows PowerShell cmdlet，系统管理员可以在目标服务器上自动运行性能分析，并使用 SPA 实现远程客户支持。 例如，系统管理员可以编写脚本，以便在特定时间间隔内调用 SPA cmdlet，以定期采样目标服务器的性能状况。

建议在使用这些 cmdlet 之前关闭 SPAConsole.exe 应用程序。

在运行任何 Windows PowerShell cmdlet 之前，你需要在控制台计算机上注册 cmdlet。

**注册 Windows PowerShell cmdlet**

1.  在提升的 Windows PowerShell 命令提示符处，键入 **registerSpaCmdlets**。 此时将显示 " **注册 SPA cmdlet 已成功** " 消息。

2.  运行 **SPA-PowerShell**。 如果将路径传递到 Windows PowerShell 脚本文件，则会自动执行这些脚本。 否则，它会打开 Windows PowerShell 命令提示符，它已准备好运行 SPA Windows PowerShell cmdlet。

下表介绍了 SPA Windows PowerShell cmdlet：

| Cmdlet 名称 | 参数 | 说明 |
| ------ | ------- | ------ |
| SpaAnalysis | **-ServerName** 目标服务器的名称。<br>**-AdvisorPackName** 要在服务器上排队的 advisor 包的完整名称。 当计划同时运行多个包时，应将参数的值设置为 AP1name，AP2name。<br>**-Duration** 数据收集的持续时间。<br>**-Credential** 在目标服务器上运行数据收集的帐户的用户凭据。<br>**-SqlInstanceName** SQL Server 实例的名称。<br>**-SqlDatabaseName** SPA 项目数据库的名称。 | 在指定的服务器上启动 SPA 数据收集会话。 |
| 停止-SpaAnalysis | **-SqlInstanceName** SQL Server 实例的名称。<br>**-SqlDatabaseName** SPA 项目数据库的名称。<br>**-ServerName** 目标服务器的名称。 | 尝试停止正在运行的 SPA 会话。 如果会话已完成，它将返回，而不执行任何操作。 |
| SpaServer | **-SqlInstanceName** SQL Server 实例的名称。<br>**-SqlDatabaseName** SPA 项目数据库的名称。 | 获取数据库中的服务器列表。 它将返回对象的列表，其中包括以下属性：名称、状态、文件共享和注释。 |
| SpaAdvisorPacks | **-SqlInstanceName** SQL Server 实例的名称<br>**-SqlDatabaseName** SPA 项目数据库的名称 | 获取数据库中的 advisor 包列表。 它将返回对象的列表，其中包括以下属性：名称、DisplayName、作者和版本。 |

Windows PowerShell 提供通过加密文件传递凭据以实现自动化方案的功能。 有关使用加密文件将凭据传递到 cmdlet 的详细信息，请参阅 [创建接受凭据的 Windows PowerShell 脚本](/previous-versions/technet-magazine/ff714574(v=msdn.10))。

### <a name="automating-spa-report-collection-by-using-windows-powershell"></a>使用 Windows PowerShell 自动收集 SPA 报表

以下过程表示如何使用 SPA Windows PowerShell cmdlet 自动执行 SPA 报表集合的示例。

可以通过 Windows PowerShell 加密和缓存用户凭据。 这些凭据用于登录到远程服务器。 下面的示例演示了此方法，但不特定于 SPA：

``` syntax
$fileName = 'D:\temp\operator.txt'
$userName = 'domainname\operator'

# save credential to file
$(Get-Credential).Password | convertFrom-SecureString | Set-Content $fileName

# load credential from file
$credential = New-Object System.Management.Automation.PsCredential $userName, $(Get-Content $fileName | convertTo-SecureString)

# run command
.\start-SpaAnalysis  ServerName: Server1  Credential: $credential  AdvisorPackName:Microsoft.ServerPerformanceAdvisor.CoreOS.V1 10  Duration:10  SqlInstanceName: .\SQLExpress  SqlDatabaseName:SPA8294
```

必须先运行**Set-executionpolicy remoteSigned** ，然后才能运行此文件。

您可以使用以下命令从批处理文件运行它：

``` syntax
PowerShell -command "& '.\RunSpa.ps1' "
```

### <a name="use-t-sql-to-generate-reports"></a>使用 T-sql 生成报告

可以使用 SQL 来提取 SPA 报表数据，以生成不在 SPAConsole.exe 中提供的自定义报表。

例如，以下 T-sql 命令提供了过去三天内的 CPU 的高10个服务器列表：

``` syntax
select TOP 10
   MachineName,
   AverageCpu
FROM (
   select
      __MachineName MachineName,
      AVG(AverageValue) AverageCpu
   FROM [SPA].[Microsoft.ServerPerformanceAdvisor.CoreOS.V1].vwCpuPerformance
   WHERE __Creationtime > dateadd(DAY, -3, GETUTcdate())
      AND Name = N'% Processor time' AND CpuId = N'_Total'
   GROUP BY __MachineName
) t
OrdER BY t.AverageCpu DESC
```

### <a name="working-with-multiple-projects"></a>处理多个项目

在某些情况下，可能需要对 SPA 使用的 SQL Server 数据库进行分区。 这有助于减少 SQL Server 数据库的数据大小或帮助你以逻辑方式对服务器进行分区。 在这些情况下，SPA 控制台支持多个项目。 您可以通过单击 " **文件**"，然后单击 " **新建项目**" 来创建新的项目数据库。 第一次使用向导时，将显示帮助创建新的项目数据库。

创建项目后，可以单击 " **文件**"，然后单击 " **打开项目** " 以在项目之间切换。 在当前打开的项目中运行未完成的性能分析时，SPA 控制台不允许切换数据库。 这是为了保护性能数据的完整性。

选择创建新的项目数据库或打开不同的项目数据库时，将关闭当前项目。 关闭当前项目时，所有打开的报表都将关闭。

**注意** SQL Server 2008 R2 Express 有 10 GB 的数据库限制。 通过使用多个项目，您可以使用一个或多个 SQL Server 数据库，并保持在 10 GB SQL Server 2008 R2 Express 限制以下。



### <a name="logging-and-debugging"></a>日志记录和调试

SPA 提供基本的日志记录功能。 它只允许将日志写入日志文件，日志文件与 SPAConsole.exe 位于同一文件夹中。 运行 SPA 控制台的用户帐户需要对安装了 SPA 的文件夹具有写入权限，以确保可以将日志写入日志文件。

SPA 包含以下有效的日志级别：

* **信息** 转储 SPA 控制台执行的每个操作的日志，它主要用于调试目的。

* **警告** 记录 SPA 控制台内发生的所有故障和异常。 某些故障只是可以由 SPA 控制台处理的验证失败。

* **关键** 仅记录 SPA 控制台无法处理的故障和异常。 这些失败会导致 SPA 控制台崩溃。 日志提供此类故障的上下文信息。

默认情况下，日志级别为 Warning，这意味着 SPA 只记录发生在 SPA 中的故障和异常。 可以通过编辑 SpaConsole.exe 所在的同一文件夹中的 **SpaConsole.exe.config** 文件来更改日志级别。 所有日志都写入同一文件夹中 log.txt 文件。

SPA 还提供了一些基本的调试功能。 若要为 SPA 启用调试，用户需要手动修改 SPA 项目数据库。 此设置存储在配置表中。 用户需要运行以下 SQL 脚本，将 SPA 项目更改为调试模式：

``` syntax
UPdate [Configurations] SET Value = N'true' WHERE Name = N'Debugmode'.
```

在调试模式下，SPA 框架将保留在性能分析期间生成的所有临时数据，以便您可以排查 advisor 包中的问题。 此脚本主要用于 advisor 包开发人员。

有关 SPA 中的调试功能的详细信息，请参阅 [服务器性能顾问包开发指南](server-performance-advisor-pack-development-guide.md)。

### <a name="managing-the-database"></a>管理数据库

### <a name="backup-and-restore-the-database"></a>备份和还原数据库

SPA 控制台并不提供用于备份和还原 SPA 数据库的功能。 应使用标准 Microsoft SQL Server 工具和脚本来备份和还原数据库。

### <a name="clean-up-the-database"></a>清理数据库

在运行更多性能分析时，SPA 项目数据库的大小会增加。 默认情况下，SPA 保留所有报表。 您可能想要删除旧报表来帮助提高性能。 您可以通过 **报表资源管理器** 界面删除报表。

## <a name="privacy-and-security"></a>隐私和安全


SPA 仅支持从目标服务器到 SPA 控制台的数据收集。 它不会将任何信息发送给 Microsoft 或非 Microsoft 开发人员。 有关 SPA 隐私的详细信息，请参阅服务器性能顾问的 Microsoft 软件许可条款。

SPA 收集的所有数据都存储在项目数据库中。 由于某些 ETW 跟踪的性质，SPA 可能会收集敏感信息，这可能会对业务产生很高的重要性。 应注意与共享对 SPA 项目数据库的访问相关的潜在风险。 临时日志文件保存在每台目标计算机上指定的共享文件夹中。 即使在数据导入完成时，SPA 尝试删除这些临时日志文件，也不能保证始终删除这些日志文件。 应确保共享文件夹位于安全位置。

SPA 顾问包包含用于分析和分析性能日志以生成性能报告的 SQL 脚本。 SPA 尝试限制运行这些脚本的特权。 但是，仍有可能脚本可以从目标服务器通过 SPA 收集敏感信息，或者获取或修改存储在同一 SPA 项目数据库中的敏感信息。 需要确保预配到 SPA 项目数据库的所有 advisor 包都来自受信任的源。

## <a name="errors-and-troubleshooting"></a>错误和故障排除


### <a name="spaconsoleexe-does-not-start-or-write-log-file"></a>SPAConsole.exe 不启动或写入日志文件

第一次尝试运行 SPAConsole.exe 时，如果未安装 .NET Framework，应用程序不会启动或写入日志文件。 在开始 SPA 之前，请确保已安装 compatible.NET 框架并且工作正常。

### <a name="locating-log-information"></a>查找日志信息

SPA 将失败信息存储在 SPA 文件夹下的 log.txt 文件中。 详细的错误消息和调用堆栈信息将写入此文件夹。 如果遇到需要解释更多信息的故障，可以打开 log.txt 文件以查看错误详细信息。

### <a name="database-size-limitations-for-sql-server-express"></a>SQL Server Express 的数据库大小限制

对于用户数据库，SQL Server Express 大小限制为 10 GB。 此大小数据库具有存储 20000-30000 报表的容量。 为了降低达到此数据库限制的可能性，建议定期删除报表，并/或使用不具有 10 GB 用户数据库限制的其他 SQL Server 版本。

### <a name="sql-server-express-log-size-and-disk-capacity"></a>SQL Server Express 日志大小和磁盘容量

如果使用 SQL Server Express，则用户数据库限制为 10 GB，但相应的日志文件可能超过 70 GB。 出于此原因，我们建议 SQL Server Express 100 GB 或更多的可用磁盘空间。 此磁盘空间应足以存储约20000到30000个报表。 此日志文件命名为 SPADB \_ ，并且位于 **% Program Files% \\ Microsoft SQL Server \\ mssql10.mssqlserver 中。SQLEXPRESS \\ MSSQL \\ 数据**。

### <a name="failure-to-connect-to-target-server"></a>未能连接到目标服务器

在目标服务器上运行性能分析时，运行 SPA 控制台的用户帐户需要具有某些权限，才能将数据收集器集在目标服务器上排队到 PLA。 还需要更改 Windows 防火墙设置，以允许通过 PLA 通信。 有关详细的配置说明，请参阅 [设置 SPA](#bkmk-setupspa)。

### <a name="failure-to-create-pla-data-collection-set-on-the-target-server"></a>无法在目标服务器上创建 PLA 数据收集组

如果您无法在目标服务器消息上创建 PLA 数据收集组，请确保执行以下操作：

* 确保 & 警报服务正在运行的**性能日志**

* "安全设置" " **网络访问：不允许存储用于网络身份验证的密码和凭据** "。 必须禁用安全设置，因为 SPA 需要使用用户凭据在目标服务器上创建数据收集组。

### <a name="running-spa-against-the-console"></a><a href="" id="running-spa-against-the-console-"></a>针对控制台运行 SPA

如果目标服务器与 SPA 控制台相同，则 PLA 会经历不同的通道。 即使用户帐户正在运行具有管理员权限的 SPA 控制台，但 PLA 也会失败。 如果 SPA 控制台安装在目标服务器上，则用户需要以管理员身份启动 SPA 才能确保性能分析任务可以在控制台上运行。

### <a name="running-multiple-consoles-at-the-same-time"></a>同时运行多个控制台

SPA 不支持同时对同一 SPA 项目数据库运行多个控制台。 SPA 还不提供锁定和同步机制来防止发生这种情况。 如果两个 SPA 控制台同时运行，则控制台的行为将会根据这些 SPA 控制台运行的时间序列而不一致。 若要防止出现这种情况，必须先从列表中删除所有已排队的性能分析会话，然后才能通过启动分析的控制台对其进行处理。

SPA 保护由 SPA 成功生成的每个报表的完整性。 同时，SPA 不能保证所有的排队分析任务都已完成。 如果在性能分析会话或错误中看到声明系统无法找到由数据收集器集生成的性能日志的状态更改，则很可能是由于对同一 SPA 项目数据库运行的多个 SPA 控制台实例导致的。

运行 SPA Windows PowerShell cmdlet 也可能受到针对同一 SPA 数据库运行的 SPA 控制台的影响。 建议在运行 SPA Windows PowerShell cmdlet 之前关闭 SPA 控制台。

### <a name="spaconsoleexe-recurring-collection-is-disrupted"></a>SPAConsole.exe 周期性回收中断

当你运行 SPAConsole.exe 并且使用定期数据收集 (例如，) 每小时的集合时，运行 SPAConsole.exe 的服务器不应处于省电模式下，使其可以暂停。 SPA 不检查是否有省电政策。 此挂起的活动可能会中断定期数据收集。

### <a name="lost-etw-events"></a>丢失 ETW 事件

若要在目标服务器上创建最小的性能影响，在收集性能信息时，PLA 设计为以低优先级运行。 如果目标服务器繁忙，则 PLA 可以删除某些数据收集任务，以生成在目标服务器上运行的高优先级任务。 你应考虑设置共享文件夹，在该文件夹中，事件写入到与工作负荷 i/o 或速度更快的驱动器（如 SSD）不冲突的磁盘上。 删除事件时，将在报表视图中报告这些事件，因为丢失的事件可能会影响生成的性能指标的可靠性。

某些权限问题还可能会导致跳过注册表或 WMI 查询。 但是，这种情况比 ETW 事件丢失少很多。 因此，数据收集器集的结果有时不包含请求的所有值。 你需要确保所有 advisor 包的 T-sql 脚本均对此情况进行处理。 如果数据收集结果中不存在该数据，则会将其标记为报表中的数据。

由于 ETW 事件损失对于 PLA 很常见，因此基于 ETW 跟踪生成的数据点可能与基于生成的数据点（例如性能计数器）不一致。 例如，可以看到 IIS 的总 CPU 使用率为 80% (来自) 的性能计数器，并且顶级 Url 仅使用所有 CPU 时间的 10% (这是来自 ETW 跟踪) 的数据点。 通常，可以通过数据点的工具提示查看一个数据点的数据源。 你应注意此类数据丢失的影响。

若要避免此类事件丢失，应关闭目标服务器的结果文件夹。

如果数据收集器结果包含不完整的数据，而不是 ETW 跟踪丢失，并且 advisor 包开发人员添加了 ETW 事件丢失通知的支持，则会在单个报表的顶部显示一个信息栏，通知用户有关数据丢失的可能不一致的报表。 log.txt 文件中可以找到详细数据丢失信息。

## <a name="glossary"></a>术语表


下面是用于 SPA 的一些术语：

* **Advisor 包** 用于处理从目标服务器收集的性能日志的元数据和 T-sql 脚本的集合。 然后，advisor 包将从性能日志数据生成报表。 Advisor 包中的元数据定义要从目标服务器收集的数据以提高性能。 该元数据还定义规则集、阈值和报表格式。 通常情况下，会专门针对单个服务器角色（例如 Internet Information Services (IIS) 编写 advisor 包。

* **Spa 控制台** SpaConsole.exe，这是 spa 的核心部分。 SPA 无需在要测试的目标服务器上运行。 SPA 控制台包含 SPA 的所有用户界面，从设置项目到运行分析和查看报表。 按照设计，SPA 是两层应用程序。 SPA 控制台包含 UI 层和部分业务逻辑层。 SPA 控制台计划并处理性能分析请求。

* **SPA 框架** 提供所有用户界面、性能日志处理、配置、错误处理以及数据库 Api 和管理过程。

* **SPA 项目** 一个数据库，其中包含有关在 advisor 包的目标服务器上生成的目标服务器、advisor 包和性能分析报表的所有信息。 您可以在同一 SPA 项目中比较和查看历史记录和趋势图表。 可以创建多个项目。 SPA 项目彼此独立，且没有跨项目共享数据。

* **目标服务器** 运行 Windows Server 的物理计算机或虚拟机，其中包含某些服务器角色，如 IIS。

* **数据分析会话** 特定目标服务器上的性能分析。 数据分析会话可包含多个 advisor 包。 来自这些顾问包的数据收集器集将合并到单个数据收集器集中。 单个数据分析会话的所有性能日志在同一时间段内收集。 分析在同一数据分析会话中运行的 advisor 包生成的报表有助于用户了解总体性能情况，并确定性能问题的根本原因。

* **Windows 事件跟踪** Windows 中提供的高性能、低开销、可缩放的跟踪系统。 它提供分析和调试功能，可用于对各种方案进行故障排除。 SPA 使用 ETW 事件作为数据源来生成性能报告。 有关 ETW 的一般信息，请参阅 [通过 Etw 改善调试和性能优化](/archive/msdn-magazine/2007/april/event-tracing-improve-debugging-and-performance-tuning-with-etw)。

* ** (WMI) Windows Management Instrumentation ** Windows 中的管理数据和操作的基础结构。 你可以编写 WMI 脚本或应用程序，以在远程计算机上自动执行管理任务。 WMI 还向操作系统的其他部分和产品提供管理数据。 SPA 使用 WMI 类信息和数据点作为源来生成性能报告。

* **性能计数器** 用于提供有关操作系统或应用程序、服务或驱动程序的运行状况的信息。 性能计数器数据可帮助确定系统瓶颈以及微调系统和应用程序性能。 操作系统、网络和设备提供应用程序可以使用的计数器数据，以便为用户提供系统运行状况的图形视图。 SPA 使用性能计数器信息和数据点作为源来生成性能报告。

* **性能日志和警报 (PLA) ** 当满足某些触发器时，收集性能日志和跟踪并引发性能警报。 PLA 可用于收集性能计数器、Windows (ETW) 、WMI 查询、注册表项和配置文件的事件跟踪。 PLA 还支持通过远程过程调用 (RPC) 进行远程数据收集。 用户定义数据收集器集，其中包括有关要收集的数据的信息、数据收集的频率、数据收集持续时间、筛选器以及保存结果文件的位置。 SPA 使用 PLA 来收集目标服务器中的所有性能数据。

* **单个报表** 基于单个目标服务器上一个 advisor 包的一个数据分析会话生成的 SPA 报表。 它可以包含通知和各种数据部分。

* **并排报表** 一种 SPA 报表，用于比较同一 advisor 包的两个单个报表。 可以从不同的目标服务器或从同一目标服务器上的单独性能分析运行生成这两个报告。 并行报告将创建比较两个报告的功能，以帮助用户识别其中一个报告中的异常行为或设置。 并行报表包含通知和各种数据部分。 在每个部分中，并排列出了这两个报表中的数据。

* **趋势图** 一种 SPA 报表，用于调查性能问题的重复模式。 许多重复的性能问题都是由服务器或客户端计算机上的计划服务器负载更改引起的，这些更改可能会每天或每周进行一次。 SPA 提供24小时趋势图和7天趋势图来确定这些问题。

    用户可以一次选择一个或多个数据序列，这是单个报表中的一个数值，例如 **平均总 CPU 使用率**。 更确切地说，数值是由单个服务器在给定的时间实例生成的标量值。 SPA 将这些值分组为24个组，一天中的每个小时 (7 个，每个7天报告一次，每周7天一次) 。 SPA 计算每个组的平均值、最小值、最大值和标准偏差。

* **历史图表** 一种 SPA 报表，用于在一段时间内显示给定服务器和顾问包对的单个报表中的特定数值的更改。 用户可以选择多个数据序列并将它们一起显示在历史图表中，以了解不同的数据系列之间的相关性。

* **数据序列** 在一段时间内从同一数据源收集的数值数据。 同一源表示数据必须来自同一目标服务器，如一台服务器上的 IIS 的平均请求队列长度。

* **规则** 逻辑、阈值和说明的组合。 它们表示潜在的性能问题。 每个 advisor 包都包含多个规则。 每个规则由报表生成进程触发。 规则将逻辑和阈值应用于单个报表中的数据。 如果满足条件，则会发出警告通知。 否则，通知将设置为 **"正常"** 状态。 如果规则不适用，则通知设置为 "不适用" (**NA**) 状态。

* **通知** 规则向用户显示的信息。 它包括规则状态 (**"确定"**、" **NA**" 或 " **警告** ") 、规则的名称和解决性能问题的可能建议。