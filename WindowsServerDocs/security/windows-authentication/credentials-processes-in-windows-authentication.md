---
title: Windows 身份验证中的凭据进程
description: Windows Server 安全
ms.topic: article
ms.assetid: 48c60816-fb8b-447c-9c8e-800c2e05b14f
ms.author: lizross
author: eross-msft
manager: mtillman
ms.date: 10/12/2016
ms.openlocfilehash: 3d2948c632697e6278b716784f68c7a0085eab07
ms.sourcegitcommit: db2d46842c68813d043738d6523f13d8454fc972
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 09/10/2020
ms.locfileid: "89640087"
---
# <a name="credentials-processes-in-windows-authentication"></a>Windows 身份验证中的凭据进程

>适用于：Windows Server（半年频道）、Windows Server 2016

本参考主题面向 IT 专业人员，介绍了 Windows 身份验证如何处理凭据。

Windows 凭据管理是操作系统从服务或用户接收凭据的过程，并保护该信息以供将来呈现到身份验证目标。 对于已加入域的计算机，身份验证目标为域控制器。 身份验证中使用的凭据是将用户标识关联到某种形式的身份验证（如证书、密码或 PIN）的数字文档。

默认情况下，将根据本地计算机上的安全帐户管理器 (SAM) 数据库或通过 Winlogon 服务在加入域的计算机上 Active Directory 验证 Windows 凭据。 凭据是通过登录用户界面上的用户输入收集的，或者通过应用程序编程接口以编程方式收集的， (API) 提供给身份验证目标。

本地安全信息存储在注册表中 **HKEY_LOCAL_MACHINE \security**下。 存储的信息包括策略设置、默认安全值和帐户信息，如缓存的登录凭据。 SAM 数据库的副本也存储在此处，尽管它是写保护的。

下图显示了所需的组件和凭据通过系统对用户或进程进行身份验证以进行成功登录的路径。

![此图显示了所需的组件和凭据通过系统对用户或进程进行身份验证以进行成功登录的路径。](../media/credentials-processes-in-windows-authentication/AuthN_LSA_Architecture_Client.gif)

下表介绍了在登录时管理身份验证过程中的凭据的每个组件。

**所有系统的身份验证组件**

|组件|说明|
|-------|--------|
|用户登录|Winlogon.exe 是负责管理安全用户交互的可执行文件。 Winlogon 服务通过将用户操作在安全桌面 (登录) 用户界面上收集的凭据传递给本地安全机构来启动 Windows 操作系统的登录过程， (LSA) 到 Secur32.dll。|
|应用程序登录|不需要交互式登录的应用程序或服务登录。 用户使用 Secur32.dll 在用户模式下运行的大多数进程，而在启动时启动的进程（如服务）使用 Ksecdd.sys 在内核模式下运行。<p>有关用户模式和内核模式的详细信息，请参阅本主题中的应用程序和用户模式或服务和内核模式。|
|Secur32.dll|构成身份验证过程基础的多身份验证提供程序。|
|Lsasrv.dll|LSA 服务器服务，它强制实施安全策略，并充当 LSA 的安全包管理器。 LSA 包含 Negotiate 函数，该函数在确定要成功的协议后选择 NTLM 或 Kerberos 协议。|
|安全支持提供程序|一组可单独调用一个或多个身份验证协议的提供程序。 默认的提供程序集可以随每个版本的 Windows 操作系统一起更改，并可以编写自定义的提供程序。|
|Netlogon.dll|Net Logon 服务执行的服务如下所示：<p>-维护计算机的安全通道 (不会与域控制器的 Schannel) 混淆。<br />-通过安全通道将用户的凭据传递到域控制器，并为用户返回域安全标识符 (Sid) 和用户权限。<br />-在域名系统 (DNS) 中发布服务资源记录，并使用 DNS 将名称解析为域控制器 (IP) 地址的 Internet 协议。<br />-根据远程过程调用 (RPC) 实现复制协议，以便同步主域控制器 (Pdc) 和备份域控制器 (Bdc) 。|
|Samsrv.dll|安全帐户管理器 (SAM) ，它存储本地安全帐户，强制实施本地存储的策略并支持 Api。|
|注册表|注册表包含 SAM 数据库的副本、本地安全策略设置、默认安全值和仅可用于系统的帐户信息。|

本主题包含以下各节：

-   [用户登录凭据输入](#BKMK_CrentialInputForUserLogon)

-   [应用程序和服务登录的凭据输入](#BKMK_CredentialInputForApplicationAndServiceLogon)

-   [本地安全机构](#BKMK_LSA)

-   [缓存的凭据和验证](#BKMK_CachedCredentialsAndValidation)

-   [凭据存储和验证](#BKMK_CredentialStorageAndValidation)

-   [安全帐户管理器数据库](#BKMK_SAM)

-   [本地域和受信任域](#BKMK_LocalDomainsAndTrustedDomains)

-   [Windows 身份验证中的证书](#BKMK_CertificatesInWindowsAuthentication)

## <a name="credential-input-for-user-logon"></a><a name="BKMK_CrentialInputForUserLogon"></a>用户登录凭据输入
在 Windows Server 2008 和 Windows Vista 中， (GINA) 体系结构的图形标识和身份验证已替换为凭据提供程序模型，这使得可以通过使用登录磁贴来枚举不同的登录类型。 下面描述了这两种模型。

**图形标识和身份验证体系结构**

图形标识和身份验证 (GINA) 体系结构适用于 Windows Server 2003、Microsoft Windows 2000 Server、Windows XP 和 Windows 2000 Professional 操作系统。 在这些系统中，每个交互登录会话都将创建一个单独的 Winlogon 服务实例。 GINA 体系结构加载到 Winlogon 使用的进程空间，接收并处理凭据，并通过 LSALogonUser 调用身份验证接口。

在会话0中运行交互式登录所用的 Winlogon 实例。 会话0承载系统服务和其他关键进程，包括本地安全机构 (LSA) 进程。

下图显示了 Windows Server 2003、Microsoft Windows 2000 Server、Windows XP 和 Microsoft Windows 2000 Professional 的凭据过程。

![显示 Windows Server 2003、Microsoft Windows 2000 Server、Windows XP 和 Microsoft Windows 2000 Professional 的凭据过程的示意图](../media/credentials-processes-in-windows-authentication/AuthN_GINA_Architecture.gif)

**凭据提供程序体系结构**

凭据提供程序体系结构适用于本主题开头的 " **适用** 于" 列表中指定的版本。 在这些系统中，凭据输入体系结构通过使用凭据提供程序更改为可扩展的设计。 这些提供程序由安全桌面上的不同登录磁贴表示，这些磁贴允许使用任意数量的登录方案-同一用户使用不同的帐户，以及不同的身份验证方法，例如密码、智能卡和生物识别。

使用凭据提供程序体系结构，Winlogon 在收到安全注意序列事件之后始终会启动登录 UI。 登录 UI 查询每个凭据提供程序，以了解提供程序配置为枚举的不同凭据类型的数量。 凭据提供程序可以选择将其中一个磁贴指定为默认磁贴。 在所有提供程序枚举其磁贴后，登录 UI 会将其显示给用户。 用户与磁贴交互以提供其凭据。 登录用户界面提交这些凭据以进行身份验证。

凭据提供程序不是强制机制。 它们用于收集和序列化凭据。 本地安全机构和身份验证包强制安全性。

凭据提供程序在计算机上注册并负责以下操作：

-   描述身份验证所需的凭据信息。

-   通过外部身份验证机构处理通信和逻辑。

-   打包凭据以进行交互式和网络登录。

为交互式登录和网络登录打包凭据包括序列化过程。 通过序列化凭据，可以在登录 UI 上显示多个登录磁贴。 因此，你的组织可以通过使用自定义凭据提供程序来控制登录显示，例如用户、用于登录的目标系统、网络和工作站锁定/解锁策略的预登录访问。 同一台计算机上可以共存多个凭据提供程序。

单一登录 (可以将 SSO) 提供程序开发为标准凭据提供程序或预登录访问提供程序。

每个版本的 Windows 都包含一个默认凭据提供程序和一个默认的预登录访问提供程序 (PLAP) （也称为 SSO 提供程序）。 SSO 提供程序允许用户在登录到本地计算机之前与网络建立连接。 实现此提供程序时，提供程序不会在登录 UI 上枚举磁贴。

SSO 提供程序用于以下方案：

-   **网络身份验证和计算机登录由不同的凭据提供程序处理。** 此方案的变体包括：

    -   用户可以选择连接到网络，例如，在登录到计算机之前连接到虚拟专用网络 (VPN) ，但不需要进行此连接。

    -   若要检索在本地计算机上进行交互式身份验证时所使用的信息，需要进行网络身份验证。

    -   多个网络身份验证后接其他方案之一。 例如，用户在 ISP)  (向 Internet 服务提供商进行身份验证，并向 VPN 进行身份验证，然后使用他们的用户帐户凭据在本地登录。

    -   缓存的凭据处于禁用状态，并且本地登录之前需要通过 VPN 的远程访问服务连接来对用户进行身份验证。

    -   域用户在加入域的计算机上没有设置本地帐户，必须在完成交互式登录之前，通过 VPN 连接建立远程访问服务连接。

-   **网络身份验证和计算机登录由同一凭据提供程序进行处理。** 在此方案中，用户在登录到计算机之前需要连接到网络。

**登录磁贴枚举**

凭据提供程序枚举以下实例中的登录磁贴：

-   本主题开头的 " **适用** 于" 列表中指定的那些操作系统。

-   凭据提供程序枚举用于工作站登录的磁贴。 凭据提供程序通常会将凭据序列化为本地安全机构进行身份验证。 此过程显示特定于每个用户的磁贴，并特定于每个用户的目标系统。

-   登录和身份验证体系结构允许用户使用凭据提供程序枚举的磁贴来解锁工作站。 通常，当前登录的用户是默认磁贴，但如果有多个用户登录，则会显示多个磁贴。

-   凭据提供程序会枚举磁贴以响应用户请求，以更改其密码或其他专用信息（如 PIN）。 通常，当前登录的用户是默认磁贴;但是，如果有多个用户登录，则会显示多个磁贴。

-   凭据提供程序基于要在远程计算机上用于身份验证的序列化凭据来枚举磁贴。 凭据 UI 使用的访问接口实例不是登录 UI，无法解锁工作站或更改密码。 因此，在凭据 UI 实例之间的提供程序中无法维护状态信息。 此结构为每台远程计算机登录生成一个磁贴，假设凭据已正确序列化。 此方案还用于 (UAC) 的用户帐户控制中，这有助于在允许可能影响计算机操作或可能更改影响计算机其他用户的设置的操作之前，提示用户提供权限或管理员密码，以帮助防止对计算机进行未经授权的更改。

下图显示了本主题开头 " **适用** 于" 列表中指定的操作系统的凭据过程。

![此图显示了本主题开头的 "适用于 * * 的列表" 中指定的操作系统的凭据过程](../media/credentials-processes-in-windows-authentication/AuthN_CredMan_CredProv.gif)

## <a name="credential-input-for-application-and-service-logon"></a><a name="BKMK_CredentialInputForApplicationAndServiceLogon"></a>应用程序和服务登录的凭据输入
Windows 身份验证设计用于管理不需要用户交互的应用程序或服务的凭据。 用户模式下的应用程序在其有权访问的系统资源方面受到限制，而服务可以对系统内存和外部设备进行不受限制的访问。

系统服务和传输级应用程序 (SSP) 通过安全支持提供程序)  (界面 SSP，它可提供用于枚举系统上可用的安全包、选择包以及使用该包获取经过身份验证的连接的功能。

当客户端/服务器连接经过身份验证时：

-   连接的客户端上的应用程序使用 SSPI 函数将凭据发送到服务器 `InitializeSecurityContext (General)` 。

-   连接服务器端上的应用程序会用 SSPI 函数响应 `AcceptSecurityContext (General)` 。

-   SSPI 函数 `InitializeSecurityContext (General)` 和 `AcceptSecurityContext (General)` 将重复，直到所有必要的身份验证消息都已交换到成功或身份验证失败。

-   对连接进行身份验证后，服务器上的 LSA 将使用客户端提供的信息来构建包含访问令牌的安全上下文。

-   服务器随后可以调用 SSPI 函数将 `ImpersonateSecurityContext` 访问令牌附加到服务的模拟线程。

**应用程序和用户模式**

Windows 中的用户模式由两个系统组成，这两个系统可以将 i/o 请求传递到相应的内核模式驱动程序：环境系统，该系统运行为多种不同类型的操作系统编写的应用程序，以及一个整型系统，它代表环境系统运行特定于系统的函数。

整型系统代表环境系统管理操作系统 system'specific 功能，由 (LSA) 、工作站服务和服务器服务的安全系统进程组成。 安全系统进程处理安全令牌，根据资源权限授予或拒绝访问用户帐户的权限，处理登录请求并启动登录身份验证，并确定操作系统需要审核的系统资源。

应用程序可以在用户模式下运行，在此模式下，应用程序可以作为任何主体运行，包括在本地 System (SYSTEM) 的安全上下文中。 应用程序还可以在内核模式下运行，在此模式下，应用程序可在本地系统 (系统) 的安全上下文中运行。

SSPI 通过 Secur32.dll 模块提供，该模块用于获取用于身份验证、消息完整性和消息隐私的集成安全服务。 它在应用程序级别协议和安全协议之间提供了一个抽象层。 因为不同的应用程序需要不同的方式来标识或验证用户，以及在数据跨网络传输时加密数据的不同方法，所以 SSPI 提供一种方法来访问动态链接库， (Dll) 包含不同的身份验证和加密功能。 这些 Dll 称为安全支持提供程序 (Ssp) 。

Windows Server 2008 R2 和 Windows 7 中引入了托管服务帐户和虚拟帐户，以提供重要的应用程序（例如 Microsoft SQL Server 和 Internet Information Services (IIS) ），并隔离其自己的域帐户，同时无需管理员手动管理这些帐户的服务主体名称 (SPN) 和凭据。 有关这些功能及其在身份验证中的角色的详细信息，请参阅 [适用于 windows 7 和 Windows Server 2008 R2 的托管服务帐户文档](/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/ff641731(v=ws.10)) 和 [组托管服务帐户概述](../group-managed-service-accounts/group-managed-service-accounts-overview.md)。

**服务和内核模式**

即使大多数 Windows 应用程序在启动这些应用程序的用户的安全上下文中运行，服务也不是这样。 许多 Windows 服务（如网络和打印服务）在用户启动计算机时由服务控制器启动。 这些服务可能作为本地服务或本地系统运行，并且可能会在上次用户注销后继续运行。

> [!NOTE]
> 服务通常在安全上下文（称为本地系统 (系统) 、网络服务或本地服务）中运行。  Windows Server 2008 R2 引入了托管服务帐户下运行的服务，这些服务是域主体。

在启动服务之前，服务控制器使用为服务指定的帐户登录，然后为 LSA 提供用于身份验证的服务凭据。 Windows 服务实现了服务控制器管理器可用于控制服务的编程接口。 当系统通过服务控制程序启动或手动启动时，可以自动启动 Windows 服务。 例如，当 Windows 客户端计算机加入域时，计算机上的 messenger 服务将连接到域控制器并打开一个安全通道。 若要获取经过身份验证的连接，该服务必须具有远程计算机的本地安全机构 (LSA) 信任的凭据。 与网络中的其他计算机进行通信时，LSA 使用本地计算机的域帐户的凭据，这与在本地系统和网络服务的安全上下文中运行的所有其他服务相同。 本地计算机上的服务作为系统运行，因此无需向 LSA 提供凭据。

文件 Ksecdd.sys 管理和加密这些凭据，并使用本地过程调用到 LSA 中。 文件类型为 WINSPOOL.DRV (driver) ，称为内核模式安全支持提供程序 (SSP) ，并且在本主题开头的 " **适用于** " 列表中指定的版本中指定的版本符合 FIPS 140-2 级别1。

内核模式对计算机的硬件和系统资源具有完全访问权限。 内核模式阻止用户模式服务和应用程序访问其无权访问的操作系统的关键区域。

## <a name="local-security-authority"></a><a name="BKMK_LSA"></a>本地安全机构
本地安全机构 (LSA) 是受保护的系统进程，用于对用户进行身份验证并将用户登录到本地计算机。 此外，LSA 维护有关计算机上的本地安全所有方面的信息 (这些方面统称为本地安全策略) ，并提供各种服务来在名称和安全标识符 (Sid) 之间进行转换。 安全系统进程（本地安全机构服务器服务 (LSASS) ）将跟踪计算机系统中生效的安全策略和帐户。

LSA 根据以下两个实体中的哪一个颁发用户帐户来验证用户的标识：

-   **本地安全机构。** LSA 可以通过检查位于同一台计算机上的安全帐户管理器 (SAM) 数据库来验证用户信息。 任何工作站或成员服务器都可以存储本地用户帐户和有关本地组的信息。 但是，这些帐户只能用于访问工作站或计算机。

-   **本地域或受信任域的安全机构。** LSA 联系颁发帐户的实体，并请求验证帐户是否有效以及请求是否源自帐户持有者。

本地安全机构子系统服务 (LSASS) 通过活动 Windows 会话以用户的名义将凭据存储在内存中。 使用存储的凭据，用户无需为每个远程服务重新输入其凭据，即可无缝访问网络资源（例如文件共享、Exchange Server 邮箱和 SharePoint 站点）。

LSASS 可以采用多种形式来存储凭据，包括：

-   反向加密的纯文本

-   Kerberos 票证 (票证授予票证 (Tgt) ，service ticket) 

-   NT 哈希

-   LAN Manager (LM) 哈希

如果用户使用智能卡登录到 Windows，则 LSASS 将不会存储纯文本密码，但会存储该帐户的相应 NT 哈希值以及智能卡的纯文本 PIN。 如果为交互式登录所需智能卡启用了帐户属性，将自动为该帐户生成一个随机的 NT 哈希值（而非原始密码哈希）。 在设置属性时自动生成的密码哈希不会发生更改。

如果用户登录到基于 Windows 的计算机时使用的密码与 LAN Manager 兼容 (LM) 哈希，则此身份验证器存在于内存中。

无法禁用内存中纯文本凭据的存储，即使禁用需要它们的凭据提供程序也是如此。

存储的凭据与在上一次重新启动后已启动并且尚未关闭的本地安全机构子系统服务 (LSASS) 登录会话直接关联。 例如，当用户执行以下任何操作时，都会创建带有已存储 LSA 凭据的 LSA 会话：

-   登录到本地会话或远程桌面协议计算机上 (RDP) 会话

-   使用“RunAs”**** 选项运行任务

-   在计算机上运行活动的 Windows 服务

-   运行计划任务或者批处理作业

-   使用远程管理工具在本地计算机上运行任务

在某些情况下，LSA 机密（只能由系统帐户进程访问的机密数据片段）存储在硬盘驱动器上。 其中一些机密是重新启动后必须保留的凭据，并且它们以加密的形式存储在硬盘驱动器上。 存储为 LSA 机密的凭据可能包括：

-   计算机的 Active Directory 域服务 (AD DS) 帐户的帐户密码

-   在计算机上配置的 Windows 服务的帐户密码

-   用于已配置的计划任务的帐户密码

-   用于 IIS 应用程序池和网站的帐户密码

-   Microsoft 帐户的密码

在 Windows 8.1 中引入的客户端操作系统为 LSA 提供附加保护，以防止未受保护的进程读取内存和代码注入。 此保护增加了 LSA 存储和管理的凭据的安全性。

有关这些其他保护的详细信息，请参阅 [配置其他 LSA 保护](../credentials-protection-and-management/configuring-additional-lsa-protection.md)。

## <a name="cached-credentials-and-validation"></a><a name="BKMK_CachedCredentialsAndValidation"></a>缓存的凭据和验证
验证机制依赖于在登录时显示凭据。 但是，当计算机从域控制器断开连接，并且用户正在提供域凭据时，Windows 将在验证机制中使用缓存凭据的进程。

用户每次登录到域时，Windows 将缓存提供的凭据，并将其存储在操作系统注册表的安全配置单元中。

使用缓存的凭据，用户无需连接到域中的域控制器即可登录域成员。


## <a name="credential-storage-and-validation"></a><a name="BKMK_CredentialStorageAndValidation"></a>凭据存储和验证
并非始终需要使用一组凭据来访问不同的资源。 例如，管理员可能希望在访问远程服务器时使用管理而不是用户凭据。 同样，如果用户访问外部资源（例如银行帐户），则该用户只能使用其域凭据以外的凭据。 以下各节介绍了当前版本的 Windows 操作系统与 Windows Vista 和 Windows XP 操作系统之间的凭据管理之间的差异。

### <a name="remote-logon-credential-processes"></a>远程登录凭据进程
远程桌面协议 (RDP) 管理使用 Windows 8 中引入的远程桌面客户端连接到远程计算机的用户的凭据。 纯文本形式的凭据将发送到主机尝试执行身份验证过程的目标主机，如果成功，则将用户连接到允许的资源。 RDP 不会将凭据存储在客户端上，而是将用户的域凭据存储在 LSASS 中。

受限制的管理模式是在 Windows Server 2012 R2 和 Windows 8.1 中引入的。 此远程桌面模式使客户端应用程序能够在对远程主机进行身份验证时，使用 NT 单向函数 (NTOWF) 或使用 Kerberos 服务票证来执行网络登录质询响应。 对管理员进行身份验证后，管理员在 LSASS 中没有相应的帐户凭据，因为未向远程主机提供这些凭据。 相反，管理员具有该会话的计算机帐户凭据。 不向远程主机提供管理员凭据，因此以计算机帐户执行操作。 资源也限制为计算机帐户，管理员无法使用自己的帐户访问资源。

### <a name="automatic-restart-sign-on-credential-process"></a>自动重启登录凭据过程
当用户在 Windows 8.1 设备上登录时，LSA 会将用户凭据保存到只能由 LSASS.exe 访问的加密内存中。 如果 Windows 更新启动自动重启而不显示用户，则使用这些凭据为用户配置自动登录。

重新启动时，用户会通过自动登录机制自动登录，然后会进一步锁定计算机以保护用户会话。 锁定通过 Winlogon 启动，而凭据管理由 LSA 完成。 通过在控制台上自动登录和锁定用户会话，用户的锁屏应用程序将重新启动并可用。

有关 ARSO 的详细信息，请参阅 [Winlogon 自动重新启动登录 &#40;ARSO&#41;](winlogon-automatic-restart-sign-on-arso.md)。

### <a name="stored-user-names-and-passwords-in-windows-vista-and-windows-xp"></a>Windows Vista 和 Windows XP 中存储的用户名和密码
在 Windows Server 2008、Windows Server 2003、Windows Vista 和 Windows XP 中，"控制面板" 中 " **存储的用户名和密码** " 简化了多组登录凭据的管理和使用，其中包括用于智能卡和 Windows Live 凭据 (现在称为 Microsoft 帐户) 的 x.509 证书。 凭据-用户配置文件的一部分存储在需要的时间。 此操作可通过确保密码是否泄露来提高每个资源的安全性，而不会危及所有安全性。

用户登录并尝试访问其他受密码保护的资源（例如服务器上的共享），并且如果用户的默认登录凭据不足以获取访问权限，则会查询 **存储的用户名和密码** 。 如果在 **存储的用户名和密码**中保存了具有正确登录信息的备用凭据，则将使用这些凭据获取访问权限。 否则，系统会提示用户提供新凭据，然后在登录会话期间或在后续会话期间，这些凭据可供重复使用。

存在以下限制：

-   如果 **存储的用户名和密码** 包含特定资源的无效或不正确的凭据，则对资源的访问被拒绝，并且不会显示 " **存储的用户名和密码** " 对话框。

-   **存储的用户名和密码** 仅存储 NTLM、Kerberos 协议 Microsoft 帐户 (以前的 WINDOWS Live ID) ，并安全套接字层 (SSL) 身份验证的凭据。 某些版本的 Internet Explorer 维护其自己的缓存以进行基本身份验证。

在 \Documents 和 Settings\Username\Application Data\Microsoft\Credentials 目录中，这些凭据会成为用户本地配置文件的加密部分。 因此，如果用户的网络策略支持漫游用户配置文件，则这些凭据可与用户漫游。 但是，如果用户在两台不同的计算机上具有 **存储用户名和密码** 的副本，并更改与其中一台计算机上的资源关联的凭据，则更改不会传播到第二台计算机上 **存储的用户名和密码** 。

### <a name="windows-vault-and-credential-manager"></a>Windows Vault 和凭据管理器
在 Windows Server 2008 R2 和 Windows 7 中引入了 "凭据管理器" 作为存储和管理用户名和密码的控制面板功能。 通过凭据管理器，用户可以存储与安全 Windows 保管库中的其他系统和网站相关的凭据。 某些版本的 Internet Explorer 使用此功能向网站进行身份验证。

使用凭据管理器管理凭据，由本地计算机用户控制。 用户可以从支持的浏览器和 Windows 应用程序保存和存储凭据，需要登录到这些资源时非常方便。 凭据保存在用户配置文件下计算机上的特殊加密文件夹中。 通过使用凭据管理器 Api) （如 web 浏览器和应用） (支持此功能的应用程序，可以在登录过程中向其他计算机和网站提供正确的凭据。

当网站、应用程序或其他计算机通过 NTLM 或 Kerberos 协议请求身份验证时，将出现一个对话框，你可以在其中选择 " **更新默认凭据** " 或 " **保存密码** " 复选框。 此对话框允许用户在本地保存凭据，由支持凭据管理器 Api 的应用程序生成。 如果用户选中 " **保存密码** " 复选框，则凭据管理器将跟踪用户的用户名、密码和正在使用的身份验证服务的相关信息。

下次使用该服务时，凭据管理器会自动提供 Windows Vault 中存储的凭据。 如果未接受凭据，将提示用户提供正确的访问信息。 如果使用新凭据授予访问权限，则凭据管理器会使用新凭据覆盖以前的凭据，然后将新凭据存储在 Windows 保管库中。

## <a name="security-accounts-manager-database"></a><a name="BKMK_SAM"></a>安全帐户管理器数据库
安全帐户管理器 (SAM) 是存储本地用户帐户和组的数据库。 它存在于每个 Windows 操作系统中;但是，在计算机加入域时，Active Directory 管理 Active Directory 域中的域帐户。

例如，运行 Windows 操作系统的客户端计算机通过与域控制器通信来加入网络域，即使没有用户登录也是如此。 若要启动通信，计算机必须在域中具有活动帐户。 在接受来自计算机的通信之前，域控制器上的 LSA 会对计算机的标识进行身份验证，然后构造计算机的安全上下文，就像它对人为安全主体的情况一样。 此安全上下文定义特定计算机或网络上的用户、服务或计算机上的用户或服务的标识和功能。 例如，安全上下文中包含的访问令牌定义 (如可以访问的文件共享或打印机) 等资源，以及可由该主体（用户、计算机或该资源上的服务）执行的操作 (如读取、写入或修改) 。

用户或计算机的安全上下文可能不同于一台计算机，例如当用户登录到服务器或工作站而不是用户自己的主工作站时。 它也可能与一个会话不同，例如当管理员修改用户的权限时。 此外，当用户或计算机在网络中或作为 Active Directory 域的一部分运行时，安全上下文通常是不同的。

## <a name="local-domains-and-trusted-domains"></a><a name="BKMK_LocalDomainsAndTrustedDomains"></a>本地域和受信任域
如果两个域之间存在信任，则每个域的身份验证机制依赖于来自其他域的身份验证的有效性。 信任有助于通过验证传入身份验证请求是否来自受信任的域)  (受信任的颁发机构，提供对资源域中共享资源的控制访问 (信任域) 。 通过这种方式，信任充当桥，只允许验证的身份验证请求在域之间传输。

特定信任通过身份验证请求的方式取决于其配置方式。 信任关系可以是单向的，即提供从受信任域到信任域中资源的访问权限，或通过提供从每个域到其他域中资源的访问权限来实现双向关系。 信任也是不可传递的，在这种情况下，信任关系仅存在于两个信任伙伴域之间或可传递，在这种情况下，信任会自动扩展到任何合作伙伴信任的其他域。

有关与身份验证有关的域和林信任关系的信息，请参阅 [委派的身份验证和信任关系](/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/dn169022(v=ws.10))。

## <a name="certificates-in-windows-authentication"></a><a name="BKMK_CertificatesInWindowsAuthentication"></a>Windows 身份验证中的证书
 (PKI) 的公钥基础结构是软件、加密技术、过程和服务的组合，使组织能够保护其通信和业务事务。 PKI 用于保护通信和业务事务的能力基于经过身份验证的用户与可信资源之间的数字证书交换。

数字证书是一种电子文档，其中包含有关其所属实体、其颁发者、唯一序列号或一些其他唯一标识、颁发和到期日期以及数字指纹的信息。

身份验证是确定远程主机是否可信任的过程。 若要建立其可信任性，远程主机必须提供可接受的身份验证证书。

远程主机通过从证书颁发机构 (CA) 获取证书来建立信任。 CA 反过来也可以从较高的机构获得认证，这会创建一个信任链。 若要确定证书是否可信，应用程序必须确定根 CA 的标识，然后确定其是否可信。

同样，远程主机或本地计算机必须确定用户或应用程序提供的证书是否可信。 用户通过 LSA 和 SSPI 提供的证书在本地计算机上进行本地登录、在网络上或通过 Active Directory 中的证书存储在域中进行授权。

为了生成证书，身份验证数据通过哈希算法（如安全哈希算法 1 (SHA1) ）传递，以生成消息摘要。 然后使用发送方的私钥对消息摘要进行数字签名，以证明消息摘要是由发送方生成的。

> [!NOTE]
> SHA1 在 Windows 7 和 Windows Vista 中是默认设置，但在 Windows 8 中已更改为 SHA2。

**智能卡身份验证**

智能卡技术是基于证书的身份验证的一个示例。 使用智能卡登录到网络提供了一种强大的身份验证形式，因为它在向域验证用户身份时使用基于加密的标识和所有权证明。 Active Directory 证书服务 (AD CS) 通过为每个智能卡颁发登录证书来提供基于加密的标识。

有关智能卡身份验证的信息，请参阅 [Windows 智能卡技术参考](/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/ff404297(v=ws.10))。

Windows 8 中引入了虚拟智能卡技术。 它将智能卡的证书存储在电脑中，然后使用设备的防篡改受信任的平台模块 (TPM) 安全芯片来保护它。 通过这种方式，PC 实际上会成为智能卡，必须接收用户的 PIN 才能进行身份验证。

**远程和无线身份验证**

远程和无线网络身份验证是使用证书进行身份验证的另一种技术。 Internet 身份验证服务 (IAS) 和虚拟专用网络服务器使用可扩展的身份验证协议-传输级别安全 (EAP-TLS) 、受保护的可扩展身份验证协议 (PEAP) 或 Internet 协议安全 (IPsec) 来针对多种类型的网络访问执行基于证书的身份验证，包括虚拟专用网 (VPN) 和无线连接。

有关网络中基于证书的身份验证的信息，请参阅 [网络访问身份验证和证书](/previous-versions/windows/it-pro/windows-server-2003/cc759575(v=ws.10))。

## <a name="see-also"></a><a name="BKMK_SeeAlso"></a>另请参阅
[Windows 身份验证概念](./windows-authentication-concepts.md)